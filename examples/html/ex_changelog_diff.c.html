<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <title>c2html for: ex_changelog_diff.c</title>
    <link rel="stylesheet" type="text/css" href="f_c.css">
  </head>
  <body>
     <h1>ex_changelog_diff.c</h1>
<pre class="c2html">
<span class="comment">/* This is a _really_simple_ program, to extract the difference between two
 * ChangeLog files. Assumptions are that the new stuff is _always_ added at the
 * front of the new file.
 *
 * Assumes mmap() will work on both files, at once.
 *
 * Assumes first 20 bytes of old ChangeLog don't change, and that any changes
 * total less than 10 bytes.
 *
 */</span>
#<span class="cppdefine">define</span> EX_UTILS_NO_USE_GET   1
#<span class="cppdefine">define</span> EX_UTILS_NO_USE_LIMIT 1
#<span class="cppdefine">define</span> EX_UTILS_NO_USE_OPEN  1

#<span class="cppinclude">include</span> <span class="str">"ex_utils.h"</span>

#<span class="cppdefine">define</span> LINE_DIFF_LEN 10

<span class="static">static</span> <span class="sizet">size_t</span> add(<span class="vstrbase">Vstr_base</span> *s1, <span class="const">const</span> <span class="char">char</span> *fname)
{
  <span class="sizet">size_t</span> old = s1-&gt;len;
  <span class="unsigned">unsigned</span> <span class="int">int</span> ern = <span class="num0">0</span>;
  
  <span class="if">if</span> (!vstr_sc_mmap_file(s1, s1-&gt;len, fname, <span class="num0">0</span>, <span class="num0">0</span>, &amp;ern))
    <span class="err">err</span>(<span class="exitfail">EXIT_FAILURE</span>, <span class="str">"mmap(%s)"</span>, fname);
  <span class="if">if</span> (old == s1-&gt;len)
    <span class="err">errx</span>(<span class="exitfail">EXIT_FAILURE</span>, <span class="str">"mmap(%s) is an empty file"</span>, fname);
    
  <span class="return">return</span> (vstr_sc_posdiff(++old, s1-&gt;len));
}

<span class="int">int</span> main(<span class="int">int</span> argc, <span class="char">char</span> *argv[])
{
  <span class="vstrbase">Vstr_base</span> *s1 = ex_init(<span class="null">NULL</span>); <span class="comment">/* init the library etc. */</span>
  <span class="sizet">size_t</span> old_f_pos = <span class="num0">0</span>;
  <span class="sizet">size_t</span> old_f_len = <span class="num0">0</span>;
  <span class="sizet">size_t</span> new_f_pos = <span class="num0">0</span>;
  <span class="sizet">size_t</span> new_f_len = <span class="num0">0</span>;
  <span class="sizet">size_t</span> srch_pos = <span class="num0">0</span>;
  <span class="sizet">size_t</span> srch_len = <span class="num0">0</span>;
  <span class="sizet">size_t</span> old_first_line_len = <span class="num0">0</span>;
  <span class="sizet">size_t</span> found = <span class="num0">0</span>;
  
  <span class="comment">/* if no arguments are given just do stdin to stdout */</span>
  <span class="if">if</span> (argc != 3)
    <span class="err">errx</span>(<span class="exitfail">EXIT_FAILURE</span>, <span class="str">"Format: %s &lt;old ChangeLog&gt; &lt;new ChangeLog&gt;"</span>, argv[0]);

  old_f_len = add(s1, argv[1]);
  new_f_len = add(s1, argv[2]);

  old_f_pos = 1;
  new_f_pos = old_f_len + 1;

  <span class="if">if</span> (old_f_len &gt; new_f_len)
    <span class="err">errx</span>(<span class="exitfail">EXIT_FAILURE</span>, <span class="str">"old ChangeLog is larger than new ChangeLog"</span>);

  srch_pos = old_f_pos + old_first_line_len;
  srch_len = old_f_len - old_first_line_len;
  old_first_line_len += vstr_spn_cstr_chrs_fwd(s1,  srch_pos, srch_len, <span class="str">"\n"</span>);
  srch_pos = old_f_pos + old_first_line_len;
  srch_len = old_f_len - old_first_line_len;
  old_first_line_len += vstr_cspn_cstr_chrs_fwd(s1, srch_pos, srch_len, <span class="str">"\n"</span>);
  srch_pos = old_f_pos + old_first_line_len;
  srch_len = old_f_len - old_first_line_len;
  old_first_line_len += vstr_spn_cstr_chrs_fwd(s1,  srch_pos, srch_len, <span class="str">"\n"</span>);

  srch_pos = new_f_pos;
  srch_len = new_f_len;
  <span class="while">while</span> ((found = vstr_srch_vstr_fwd(s1, srch_pos, srch_len,
                                     s1, old_f_pos, old_first_line_len)))
  {
    <span class="sizet">size_t</span> oln_len = vstr_sc_posdiff(found, s1-&gt;len);

    <span class="if">if</span> (oln_len &gt; old_f_len)
    { <span class="if">if</span> ((oln_len   - old_f_len) &lt;= LINE_DIFF_LEN) break; }
    <span class="else">else</span>
    { <span class="if">if</span> ((old_f_len - oln_len)   &lt;= LINE_DIFF_LEN) break; }
    
    srch_pos = found + 1;
    srch_len = vstr_sc_posdiff(srch_pos, s1-&gt;len);
  }

  <span class="if">if</span> (!found)
    <span class="err">errx</span>(<span class="exitfail">EXIT_FAILURE</span>, <span class="str">"old ChangeLog doesn't have a line of data"</span>);
  
  vstr_del(s1, found, vstr_sc_posdiff(found, s1-&gt;len));
  vstr_del(s1, old_f_pos, old_f_len);

  <span class="comment">/* get rid of blanks from beg. and end */</span>
  vstr_del(s1, 1, vstr_spn_cstr_chrs_fwd(s1, 1, s1-&gt;len, <span class="str">"\n"</span>));
  srch_len = vstr_spn_cstr_chrs_rev(s1, 1, s1-&gt;len, <span class="str">"\n"</span>);
  <span class="if">if</span> (srch_len)
    vstr_sc_reduce(s1, 1, s1-&gt;len, srch_len - 1);
  
  <span class="comment">/* output all remaining data */</span>
  io_put_all(s1, <span class="stdout">STDOUT_FILENO</span>);

  <span class="exit">exit</span> (ex_exit(s1, <span class="null">NULL</span>));
}
</pre>
<!-- C to html convertion of ex_changelog_diff.c -->
<!--   done on Thu May 13 03:35:33 2004 -->
<!--   done by ex_highlight -->

  </body>
</html>
