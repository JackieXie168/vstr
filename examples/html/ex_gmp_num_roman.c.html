<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <title>c2html for: ex_gmp_num_roman.c</title>
    <link rel="stylesheet" type="text/css" href="f_c.css">
  </head>
  <body>
     <h1>ex_gmp_num_roman.c</h1>
<pre class="c2html">
<span class="comment">/* This is prints roman numerals.
 * Inspired by http://www.differentpla.net/node/view/58
 * Requires GMP
 */</span>

<span class="comment">/* we only need output here, so turn off other IO functions */</span>
#<span class="cppdefine">define</span> EX_UTILS_NO_USE_INPUT 1
#<span class="cppdefine">define</span> EX_UTILS_NO_USE_OPEN 1
#<span class="cppinclude">include</span> <span class="str">"ex_utils.h"</span>

#<span class="cppinclude">include</span> &lt;limits.h&gt;
#<span class="cppinclude">include</span> &lt;gmp.h&gt;

<span class="comment">/* do we want to test that it works? */</span>
#<span class="cppdefine">define</span> EX_ROMAN_USE_TST <span class="num0">0</span>

#<span class="cppdefine">define</span> ROMAN_MAKE(num, out)                        \
    {num, out, sizeof(out) - 1}                     \
    

<span class="static">static</span> <span class="sizet">size_t</span> roman_conv(<span class="vstrbase">Vstr_base</span> *s1, <span class="sizet">size_t</span> pos, <span class="const">const</span> <span class="mpzt">mpz_t</span> num)
{
  struct Roman_conv
  {
   <span class="const">const</span> <span class="unsigned">unsigned</span> <span class="int">int</span> num;
   <span class="const">const</span> <span class="char">char</span> *str;
   <span class="const">const</span> <span class="sizet">size_t</span> len;
  };
  
  <span class="static">static</span> struct Roman_conv conv[] =
    {
     ROMAN_MAKE(1000, <span class="str">"M"</span>),
     ROMAN_MAKE(900,  <span class="str">"CM"</span>),
     ROMAN_MAKE(500,  <span class="str">"D"</span>),
     ROMAN_MAKE(400,  <span class="str">"CD"</span>),
     ROMAN_MAKE(100,  <span class="str">"C"</span>),
     ROMAN_MAKE(90,   <span class="str">"XC"</span>),
     ROMAN_MAKE(50,   <span class="str">"L"</span>),
     ROMAN_MAKE(40,   <span class="str">"XL"</span>),
     ROMAN_MAKE(10,   <span class="str">"X"</span>),
     ROMAN_MAKE(9,    <span class="str">"IX"</span>),
     ROMAN_MAKE(5,    <span class="str">"V"</span>),
     ROMAN_MAKE(4,    <span class="str">"IV"</span>),
     ROMAN_MAKE(1,    <span class="str">"I"</span>),
    };
  <span class="const">const</span> struct Roman_conv *scan = conv;
  <span class="unsigned">unsigned</span> <span class="int">int</span> alen = sizeof(conv) / sizeof(conv[0]);
  <span class="sizet">size_t</span> ret = <span class="num0">0</span>;
  <span class="mpzt">mpz_t</span> tmp;
  
  mpz_init_set(tmp, num);
  mpz_abs(tmp, tmp);
  
  <span class="while">while</span> (alen)
  {
    <span class="while">while</span> (mpz_cmp_ui(tmp, scan-&gt;num) &gt;= <span class="num0">0</span>)
    {
      mpz_sub_ui(tmp, tmp, scan-&gt;num);

      <span class="if">if</span> (s1 &amp;&amp; !vstr_add_buf(s1, pos, scan-&gt;str, scan-&gt;len))
        <span class="return">return</span> (<span class="num0">0</span>);
      
      pos += scan-&gt;len;
      ret += scan-&gt;len;
    }

    --alen;
    ++scan;
  }

  
  <span class="return">return</span> (ret);
}

<span class="comment">/* This is the custom formatter. */</span>
<span class="static">static</span> <span class="int">int</span> ex__usr_roman_cb(<span class="vstrbase">Vstr_base</span> *base, <span class="sizet">size_t</span> pos, <span class="vstrfmt">Vstr_fmt_spec</span> *spec,
                            <span class="const">const</span> <span class="mpzt">mpz_t</span> val)
{
  <span class="int">int</span> flags = VSTR_FLAG_SC_FMT_CB_BEG_OBJ_NUM; <span class="comment">/* it's a number */</span>
  <span class="sizet">size_t</span> len = <span class="num0">0</span>;

  <span class="if">if</span> (mpz_sgn(val) == <span class="numm1">-1</span>)
    flags |= VSTR_FLAG_SC_FMT_CB_BEG_OBJ_NEG;
  
  len = roman_conv(<span class="null">NULL</span>, <span class="num0">0</span>, val);
  
  <span class="comment">/* Not handled atm. */</span>
  spec-&gt;fmt_quote = <span class="num0">0</span>;
  
  <span class="if">if</span> (!vstr_sc_fmt_cb_beg(base, &amp;pos, spec, &amp;len, flags))
    <span class="return">return</span> (<span class="false">FALSE</span>);
 
  <span class="if">if</span> (!roman_conv(base, pos, val))
    <span class="return">return</span> (<span class="false">FALSE</span>);
    
  <span class="if">if</span> (!vstr_sc_fmt_cb_end(base, pos, spec, len))
    <span class="return">return</span> (<span class="false">FALSE</span>);
  
  <span class="return">return</span> (<span class="true">TRUE</span>);
}

<span class="comment">/* Extra, do binary output... */</span>
<span class="static">static</span> <span class="int">int</span> ex_usr_roman_cb(<span class="vstrbase">Vstr_base</span> *base, <span class="sizet">size_t</span> pos, <span class="vstrfmt">Vstr_fmt_spec</span> *spec)
{
  <span class="void">void</span> *mpz = VSTR_FMT_CB_ARG_PTR(spec, <span class="num0">0</span>);

  <span class="return">return</span> (ex__usr_roman_cb(base, pos, spec, mpz));
}

<span class="int">int</span> main(<span class="int">int</span> argc, <span class="char">char</span> *argv[])
{
  <span class="vstrbase">Vstr_base</span> *s1 = ex_init(<span class="null">NULL</span>);
  <span class="mpzt">mpz_t</span> bignum;
  
  <span class="if">if</span> (argc &lt; 2)
    <span class="err">errx</span>(<span class="exitfail">EXIT_FAILURE</span>, <span class="str">"No count specified"</span>);

  vstr_cntl_conf(s1-&gt;conf, VSTR_CNTL_CONF_SET_FMT_CHAR_ESC, <span class="chr">'$'</span>);
  <span class="if">if</span> (!vstr_sc_fmt_add_vstr(s1-&gt;conf, <span class="str">"{vstr:%p%zu%zu%u}"</span>) ||
      !vstr_fmt_add(s1-&gt;conf, <span class="str">"&lt;roman:%p&gt;"</span>, ex_usr_roman_cb,
                    VSTR_TYPE_FMT_PTR_VOID, VSTR_TYPE_FMT_END))
    <span class="errno">errno</span> = ENOMEM, <span class="err">err</span>(<span class="exitfail">EXIT_FAILURE</span>, <span class="str">"Custom formatters"</span>);

#<span class="cppif">if</span> EX_ROMAN_USE_TST
  {
    struct Roman_tst_conv
    {
     <span class="const">const</span> <span class="char">char</span> *i;
     <span class="const">const</span> <span class="char">char</span> *o;
    }
    tsts[] =
      {
       {<span class="str">"0"</span>,   <span class="str">""</span>},
       {<span class="str">"1"</span>,   <span class="str">"I"</span>},
       {<span class="str">"2"</span>,   <span class="str">"II"</span>},
       {<span class="str">"3"</span>,   <span class="str">"III"</span>},
       {<span class="str">"4"</span>,   <span class="str">"IV"</span>},
       {<span class="str">"5"</span>,   <span class="str">"V"</span>},
       {<span class="str">"6"</span>,   <span class="str">"VI"</span>},
       {<span class="str">"7"</span>,   <span class="str">"VII"</span>},
       {<span class="str">"8"</span>,   <span class="str">"VIII"</span>},
       {<span class="str">"9"</span>,   <span class="str">"IX"</span>},
       {<span class="str">"10"</span>,  <span class="str">"X"</span>},
       {<span class="str">"11"</span>,  <span class="str">"XI"</span>},
       {<span class="str">"12"</span>,  <span class="str">"XII"</span>},
       {<span class="str">"13"</span>,  <span class="str">"XIII"</span>},
       {<span class="str">"14"</span>,  <span class="str">"XIV"</span>},
       {<span class="str">"15"</span>,  <span class="str">"XV"</span>},
       {<span class="str">"16"</span>,  <span class="str">"XVI"</span>},
       {<span class="str">"17"</span>,  <span class="str">"XVII"</span>},
       {<span class="str">"18"</span>,  <span class="str">"XVIII"</span>},
       {<span class="str">"19"</span>,  <span class="str">"XIX"</span>},
       {<span class="str">"20"</span>,  <span class="str">"XX"</span>},
       {<span class="str">"21"</span>,  <span class="str">"XXI"</span>},
       {<span class="str">"29"</span>,  <span class="str">"XXIX"</span>},
       {<span class="str">"30"</span>,  <span class="str">"XXX"</span>},
       {<span class="str">"34"</span>,  <span class="str">"XXXIV"</span>},
       {<span class="str">"40"</span>,  <span class="str">"XL"</span>},
       {<span class="str">"50"</span>,  <span class="str">"L"</span>},
       {<span class="str">"60"</span>,  <span class="str">"LX"</span>},
       {<span class="str">"70"</span>,  <span class="str">"LXX"</span>},
       {<span class="str">"80"</span>,  <span class="str">"LXXX"</span>},
       {<span class="str">"90"</span>,  <span class="str">"XC"</span>},
       {<span class="str">"100"</span>, <span class="str">"C"</span>},
       {<span class="str">"190"</span>, <span class="str">"CXC"</span>},
       {<span class="str">"200"</span>, <span class="str">"CC"</span>},
       {<span class="str">"300"</span>, <span class="str">"CCC"</span>},
       {<span class="str">"400"</span>, <span class="str">"CD"</span>},
       {<span class="str">"500"</span>, <span class="str">"D"</span>},
       {<span class="str">"600"</span>, <span class="str">"DC"</span>},
       {<span class="str">"700"</span>, <span class="str">"DCC"</span>},
       {<span class="str">"800"</span>, <span class="str">"DCCC"</span>},
       {<span class="str">"900"</span>, <span class="str">"CM"</span>},
       {<span class="str">"1000"</span>, <span class="str">"M"</span>},
                                                                                
       {<span class="str">"1900"</span>, <span class="str">"MCM"</span>},
       {<span class="str">"1975"</span>, <span class="str">"MCMLXXV"</span>},
       {<span class="str">"1989"</span>, <span class="str">"MCMLXXXIX"</span>},
       {<span class="str">"1999"</span>, <span class="str">"MCMXCIX"</span>},
       {<span class="str">"2000"</span>, <span class="str">"MM"</span>},
       {<span class="str">"2001"</span>, <span class="str">"MMI"</span>},
#<span class="cppdefine">define</span> M10() <span class="str">"MMMMMMMMMM"</span>
#<span class="cppdefine">define</span> M100()    M10() M10() M10() M10() M10() M10() M10() M10() M10() M10()
#<span class="cppdefine">define</span> M1_000()  M100()M100()M100()M100()M100()M100()M100()M100()M100()M100()
#<span class="cppdefine">define</span> M10_000() M1_000()M1_000()M1_000()M1_000()M1_000() \
                  M1_000()M1_000()M1_000()M1_000()M1_000()
#<span class="cppdefine">define</span> M100_000() M10_000()M10_000()M10_000()M10_000()M10_000() \
                   M10_000()M10_000()M10_000()M10_000()M10_000()
#<span class="cppdefine">define</span> M1_000_000() M100_000()M100_000()M100_000()M100_000()M100_000() \
                     M100_000()M100_000()M100_000()M100_000()M100_000()
#<span class="cppdefine">define</span> M10_000_000() M1_000_000()M1_000_000()M1_000_000()M1_000_000()M1_000_000() \
                      M1_000_000()M1_000_000()M1_000_000()M1_000_000()M1_000_000()
       {<span class="str">"10004"</span>, M10() <span class="str">"IV"</span>},
       {<span class="str">"12345"</span>, M10() <span class="str">"MMCCCXLV"</span>},
       {<span class="str">"10000000053"</span>, M10_000_000() <span class="str">"LIII"</span>},
      };
    <span class="unsigned">unsigned</span> <span class="int">int</span> alen = sizeof(tsts) / sizeof(tsts[0]);
    struct Roman_tst_conv *scan = tsts;
    

    <span class="while">while</span> (alen)
    {
      mpz_init_set_str(bignum, scan-&gt;i, <span class="num0">0</span>);

      vstr_del(s1, 1, s1-&gt;len);
      vstr_add_fmt(s1, s1-&gt;len, <span class="str">"$&lt;roman:%p&gt;"</span>, (<span class="void">void</span> *)bignum);
      
      <span class="if">if</span> (!vstr_cmp_cstr_eq(s1, 1, s1-&gt;len, scan-&gt;o))
        <span class="err">errx</span>(<span class="exitfail">EXIT_FAILURE</span>, <span class="str">"Tst failed(%s): %s"</span>,
             scan-&gt;o, vstr_export_cstr_ptr(s1, 1, s1-&gt;len));

      --alen;
      ++scan;
    }
  }
#<span class="cppendif">endif</span>
  
  mpz_init_set_str(bignum, argv[1], <span class="num0">0</span>);

  vstr_del(s1, 1, s1-&gt;len);
  vstr_add_fmt(s1, s1-&gt;len, <span class="str">" Input: %s\n"</span>, argv[1]);
  vstr_add_fmt(s1, s1-&gt;len, <span class="str">" Roman: $&lt;roman:%p&gt;\n"</span>, (<span class="void">void</span> *)bignum);
  
  <span class="if">if</span> (s1-&gt;conf-&gt;malloc_bad)
    <span class="errno">errno</span> = ENOMEM, <span class="err">err</span>(<span class="exitfail">EXIT_FAILURE</span>, <span class="str">"Add string data"</span>);
  
  io_put_all(s1, <span class="stdout">STDOUT_FILENO</span>);

  <span class="exit">exit</span> (ex_exit(s1, <span class="null">NULL</span>));
}
</pre>
<!-- C to html convertion of ex_gmp_num_roman.c -->
<!--   done on Thu May 13 04:41:00 2004 -->
<!--   done by ex_highlight -->

  </body>
</html>
