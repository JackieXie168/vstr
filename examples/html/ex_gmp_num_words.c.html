<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <title>c2html for: ex_gmp_num_words.c</title>
    <link rel="stylesheet" type="text/css" href="f_c.css">
  </head>
  <body>
     <h1>ex_gmp_num_words.c</h1>
<pre class="c2html">
<span class="comment">/* This is prints US words for a number.
   http://www.jimloy.com/math/billion.htm
 */</span>

<span class="comment">/* we only need output here, so turn off other IO functions */</span>
#<span class="cppdefine">define</span> EX_UTILS_NO_USE_INPUT 1
#<span class="cppdefine">define</span> EX_UTILS_NO_USE_OPEN 1
#<span class="cppinclude">include</span> <span class="str">"ex_utils.h"</span>

#<span class="cppinclude">include</span> &lt;limits.h&gt;
#<span class="cppinclude">include</span> &lt;gmp.h&gt;

<span class="comment">/* do we want to test that it works? */</span>
#<span class="cppdefine">define</span> EX_WORDS_USE_TST 1

#<span class="cppdefine">define</span> VAL0_3()    <span class="str">"000"</span>
#<span class="cppdefine">define</span> VAL0_6()    VAL0_3()VAL0_3()
#<span class="cppdefine">define</span> VAL0_9()    VAL0_3()VAL0_3()VAL0_3()
#<span class="cppdefine">define</span> VAL0_10()   <span class="str">"0"</span> VAL0_9()
#<span class="cppdefine">define</span> VAL0_12()   VAL0_3()VAL0_3()VAL0_3()VAL0_3()
#<span class="cppdefine">define</span> VAL0_15()   VAL0_3()VAL0_3()VAL0_3()VAL0_3()VAL0_3()
#<span class="cppdefine">define</span> VAL0_30()   VAL0_15()VAL0_15()
#<span class="cppdefine">define</span> VAL0_50()   VAL0_10()VAL0_10()VAL0_10()VAL0_10()VAL0_10()
#<span class="cppdefine">define</span> VAL0_60()   VAL0_30()VAL0_30()
#<span class="cppdefine">define</span> VAL0_100()  VAL0_50()VAL0_50()
#<span class="cppdefine">define</span> VAL0_300()  VAL0_100()VAL0_100()VAL0_100()

#<span class="cppdefine">define</span> WORDS_MAKE(num, out)                        \
    {num, <span class="str">" "</span> out, sizeof(out), {{0, <span class="num0">0</span>, NULL}}}     \

#<span class="cppdefine">define</span> WORDS_ADD_WORD()                        \
    <span class="if">if</span> (s1 &amp;&amp; !vstr_add_ptr(s1, pos, scan-&gt;str, scan-&gt;len))     \
      <span class="return">return</span> (<span class="num0">0</span>);                                               \
                                                                \
    pos += scan-&gt;len;                                           \
    ret += scan-&gt;len

<span class="comment">/* can't be bothered doing the english version ...
 * we often just use the american version anyway. */</span>
<span class="static">static</span> <span class="sizet">size_t</span> words_conv(<span class="vstrbase">Vstr_base</span> *s1, <span class="sizet">size_t</span> pos, <span class="const">const</span> <span class="mpzt">mpz_t</span> num,
                         <span class="int">int</span> cap, <span class="int">int</span> del)
{
  <span class="sizet">size_t</span> orig_pos = pos;
  struct Words_conv
  {
   <span class="const">const</span> <span class="char">char</span> *num;
   <span class="const">const</span> <span class="char">char</span> *str;
   <span class="const">const</span> <span class="sizet">size_t</span> len;
   <span class="mpzt">mpz_t</span> bignum;
  };
  <span class="static">static</span> struct Words_conv conv_m[] =
    {
#<span class="cppif">if</span> <span class="num0">0</span>
     WORDS_MAKE(<span class="str">"1"</span> VAL0_300() VAL0_3(),           <span class="str">"centillion"</span>),
     WORDS_MAKE(<span class="str">"1"</span> VAL0_60() VAL0_3(),            <span class="str">"vigintillion"</span>),
     WORDS_MAKE(<span class="str">"1"</span> VAL0_60(),                     <span class="str">"novemdecillion"</span>),
     WORDS_MAKE(<span class="str">"1"</span> VAL0_30() VAL0_15() VAL0_12(), <span class="str">"octodecillion"</span>),
     WORDS_MAKE(<span class="str">"1"</span> VAL0_30() VAL0_15() VAL0_9(),  <span class="str">"septendecillion"</span>),
     WORDS_MAKE(<span class="str">"1"</span> VAL0_30() VAL0_15() VAL0_6(),  <span class="str">"sexdecillion"</span>),
     WORDS_MAKE(<span class="str">"1"</span> VAL0_30() VAL0_15() VAL0_3(),  <span class="str">"quindecillion"</span>),
     WORDS_MAKE(<span class="str">"1"</span> VAL0_30() VAL0_15(),           <span class="str">"quattuordecillion"</span>),
     WORDS_MAKE(<span class="str">"1"</span> VAL0_30() VAL0_12(),           <span class="str">"tredecillion"</span>),
     WORDS_MAKE(<span class="str">"1"</span> VAL0_30() VAL0_9(),            <span class="str">"duodecillion"</span>),
     WORDS_MAKE(<span class="str">"1"</span> VAL0_30() VAL0_6(),            <span class="str">"undecillion"</span>),
     WORDS_MAKE(<span class="str">"1"</span> VAL0_30() VAL0_3(),            <span class="str">"decillion"</span>),
     WORDS_MAKE(<span class="str">"1"</span> VAL0_30(),                     <span class="str">"nonillion"</span>),
     WORDS_MAKE(<span class="str">"1"</span> VAL0_15() VAL0_12(),           <span class="str">"octillion"</span>),
     WORDS_MAKE(<span class="str">"1"</span> VAL0_15() VAL0_9(),            <span class="str">"septillion"</span>),
     WORDS_MAKE(<span class="str">"1"</span> VAL0_15() VAL0_6(),            <span class="str">"sextillion"</span>),
#<span class="cppendif">endif</span>
     WORDS_MAKE(<span class="str">"1"</span> VAL0_15() VAL0_3(),            <span class="str">"quintillion"</span>),
     WORDS_MAKE(<span class="str">"1"</span> VAL0_15(),                     <span class="str">"quadrillion"</span>),
     WORDS_MAKE(<span class="str">"1"</span> VAL0_12(),                     <span class="str">"trillion"</span>),
     WORDS_MAKE(<span class="str">"1"</span> VAL0_9(),                      <span class="str">"billion"</span>),
     WORDS_MAKE(<span class="str">"1"</span> VAL0_6(),                      <span class="str">"million"</span>),
     WORDS_MAKE(<span class="str">"1"</span> VAL0_3(),                      <span class="str">"thousand"</span>),
     WORDS_MAKE(<span class="str">"100"</span>,                             <span class="str">"hundred"</span>),
    };
  <span class="static">static</span> struct Words_conv conv_and =
     WORDS_MAKE(<span class="str">"&amp;"</span>,                               <span class="str">"and"</span>);
  <span class="static">static</span> struct Words_conv conv_a[] =
    {
     WORDS_MAKE(<span class="str">"90"</span>,                              <span class="str">"ninety"</span>),
     WORDS_MAKE(<span class="str">"80"</span>,                              <span class="str">"eighty"</span>),
     WORDS_MAKE(<span class="str">"70"</span>,                              <span class="str">"seventy"</span>),
     WORDS_MAKE(<span class="str">"60"</span>,                              <span class="str">"sixty"</span>),
     WORDS_MAKE(<span class="str">"50"</span>,                              <span class="str">"fifty"</span>),
     WORDS_MAKE(<span class="str">"40"</span>,                              <span class="str">"forty"</span>),
     WORDS_MAKE(<span class="str">"30"</span>,                              <span class="str">"thirty"</span>),
     WORDS_MAKE(<span class="str">"20"</span>,                              <span class="str">"twenty"</span>),
     WORDS_MAKE(<span class="str">"19"</span>,                              <span class="str">"nineteen"</span>),
     WORDS_MAKE(<span class="str">"18"</span>,                              <span class="str">"eighteen"</span>),
     WORDS_MAKE(<span class="str">"17"</span>,                              <span class="str">"seventeen"</span>),
     WORDS_MAKE(<span class="str">"16"</span>,                              <span class="str">"sixteen"</span>),
     WORDS_MAKE(<span class="str">"15"</span>,                              <span class="str">"fifteen"</span>),
     WORDS_MAKE(<span class="str">"14"</span>,                              <span class="str">"fourteen"</span>),
     WORDS_MAKE(<span class="str">"13"</span>,                              <span class="str">"thirteen"</span>),
     WORDS_MAKE(<span class="str">"12"</span>,                              <span class="str">"twelve"</span>),
     WORDS_MAKE(<span class="str">"11"</span>,                              <span class="str">"eleven"</span>),
     WORDS_MAKE(<span class="str">"10"</span>,                              <span class="str">"ten"</span>),
     WORDS_MAKE(<span class="str">"9"</span>,                               <span class="str">"nine"</span>),
     WORDS_MAKE(<span class="str">"8"</span>,                               <span class="str">"eight"</span>),
     WORDS_MAKE(<span class="str">"7"</span>,                               <span class="str">"seven"</span>),
     WORDS_MAKE(<span class="str">"6"</span>,                               <span class="str">"six"</span>),
     WORDS_MAKE(<span class="str">"5"</span>,                               <span class="str">"five"</span>),
     WORDS_MAKE(<span class="str">"4"</span>,                               <span class="str">"four"</span>),
     WORDS_MAKE(<span class="str">"3"</span>,                               <span class="str">"three"</span>),
     WORDS_MAKE(<span class="str">"2"</span>,                               <span class="str">"two"</span>),
     WORDS_MAKE(<span class="str">"1"</span>,                               <span class="str">"one"</span>),
    };
  <span class="static">static</span> struct Words_conv conv_zero =
     WORDS_MAKE(<span class="str">"0"</span>,                               <span class="str">"zero"</span>);
  <span class="static">static</span> struct Words_conv conv_minus =
     WORDS_MAKE(<span class="str">"-"</span>,                               <span class="str">"minus"</span>);  
  <span class="static">static</span> <span class="int">int</span> done = <span class="false">FALSE</span>;
  struct Words_conv *scan = conv_m;
  <span class="unsigned">unsigned</span> <span class="int">int</span> alen = sizeof(conv_m) / sizeof(conv_m[0]);
  <span class="sizet">size_t</span> ret = <span class="num0">0</span>;
  <span class="mpzt">mpz_t</span> tmp;

  <span class="if">if</span> (!done)
  {
    <span class="while">while</span> (alen)
    {
      mpz_init_set_str(scan-&gt;bignum, scan-&gt;num, 10);
      
      --alen;
      ++scan;
    }
    scan = conv_a;
    alen = sizeof(conv_a) / sizeof(conv_a[0]);
    <span class="while">while</span> (alen)
    {
      mpz_init_set_str(scan-&gt;bignum, scan-&gt;num, 10);
      
      --alen;
      ++scan;
    }
    
    scan = conv_m;
    alen = sizeof(conv_m) / sizeof(conv_m[0]);
    
    done = <span class="true">TRUE</span>;
  }
  
  mpz_init_set(tmp, num);
  mpz_abs(tmp, tmp);

  <span class="if">if</span> (mpz_cmp_ui(num, <span class="num0">0</span>) == <span class="num0">0</span>)
  {
    scan = &amp;conv_zero;
    WORDS_ADD_WORD();
  }
  <span class="else">else</span>
  {
    <span class="while">while</span> (alen)
    {
      <span class="mpzt">mpz_t</span> quo;

      mpz_init(quo);
      
      <span class="while">while</span> (mpz_cmp(tmp, scan-&gt;bignum) &gt;= <span class="num0">0</span>)
      {
        <span class="sizet">size_t</span> front = <span class="num0">0</span>;
        
        mpz_tdiv_qr(quo, tmp, tmp, scan-&gt;bignum);

        <span class="if">if</span> (!(front = words_conv(s1, pos, quo, <span class="false">FALSE</span>, <span class="false">FALSE</span>)))
          <span class="return">return</span> (<span class="num0">0</span>);
        ret += front;
        pos += front;

        WORDS_ADD_WORD();
      }
      
      --alen;
      ++scan;
    }

    <span class="if">if</span> (ret &amp;&amp; (mpz_cmp_ui(tmp, <span class="num0">0</span>) != <span class="num0">0</span>))
    {
      scan = &amp;conv_and;
      WORDS_ADD_WORD();
    }

    scan = conv_a;
    alen = sizeof(conv_a) / sizeof(conv_a[0]);
    <span class="while">while</span> (alen)
    {
      <span class="while">while</span> (mpz_cmp(tmp, scan-&gt;bignum) &gt;= <span class="num0">0</span>)
      {
        mpz_mod(tmp, tmp, scan-&gt;bignum);
        WORDS_ADD_WORD();
      }
      
      --alen;
      ++scan;
    }
  }
  
  <span class="assert">ASSERT</span>(ret &gt;= 2);
  
  <span class="if">if</span> (mpz_sgn(num) == <span class="numm1">-1</span>)
  {
    scan = &amp;conv_minus;
    pos  = orig_pos;
    WORDS_ADD_WORD();
  }
  
  <span class="assert">ASSERT</span>(ret &gt;= 2);

  ++orig_pos;
  <span class="if">if</span> (del)
  { <span class="comment">/* get rid of space */</span>
    <span class="if">if</span> (s1) vstr_del(s1, orig_pos, 1);
    --ret;
  }
  
  <span class="if">if</span> (cap &amp;&amp; s1 &amp;&amp; !vstr_conv_uppercase(s1, orig_pos, 1)) <span class="comment">/* capitalize */</span>
    <span class="return">return</span> (<span class="num0">0</span>);
  
  <span class="return">return</span> (ret);
}

<span class="comment">/* This is the custom formatter. */</span>
<span class="static">static</span> <span class="int">int</span> ex__usr_words_cb(<span class="vstrbase">Vstr_base</span> *base, <span class="sizet">size_t</span> pos, <span class="vstrfmt">Vstr_fmt_spec</span> *spec,
                            <span class="const">const</span> <span class="mpzt">mpz_t</span> val)
{
  <span class="int">int</span> flags = VSTR_FLAG_SC_FMT_CB_BEG_OBJ_ATOM;
  <span class="sizet">size_t</span> len = <span class="num0">0</span>;
  
  len = words_conv(<span class="null">NULL</span>, <span class="num0">0</span>, val, <span class="true">TRUE</span>, <span class="true">TRUE</span>);
  
  <span class="comment">/* Not handled atm. */</span>
  spec-&gt;fmt_quote = <span class="num0">0</span>;
  
  <span class="if">if</span> (!vstr_sc_fmt_cb_beg(base, &amp;pos, spec, &amp;len, flags))
    <span class="return">return</span> (<span class="false">FALSE</span>);
 
  <span class="if">if</span> (!words_conv(base, pos, val, <span class="true">TRUE</span>, <span class="true">TRUE</span>))
    <span class="return">return</span> (<span class="false">FALSE</span>);
    
  <span class="if">if</span> (!vstr_sc_fmt_cb_end(base, pos, spec, len))
    <span class="return">return</span> (<span class="false">FALSE</span>);
  
  <span class="return">return</span> (<span class="true">TRUE</span>);
}

<span class="comment">/* Extra, do binary output... */</span>
<span class="static">static</span> <span class="int">int</span> ex_usr_words_cb(<span class="vstrbase">Vstr_base</span> *base, <span class="sizet">size_t</span> pos, <span class="vstrfmt">Vstr_fmt_spec</span> *spec)
{
  <span class="void">void</span> *mpz = VSTR_FMT_CB_ARG_PTR(spec, <span class="num0">0</span>);

  <span class="return">return</span> (ex__usr_words_cb(base, pos, spec, mpz));
}

<span class="int">int</span> main(<span class="int">int</span> argc, <span class="char">char</span> *argv[])
{
  <span class="vstrbase">Vstr_base</span> *s1 = ex_init(<span class="null">NULL</span>);
  <span class="mpzt">mpz_t</span> bignum;
  
  <span class="if">if</span> (argc &lt; 2)
    <span class="err">errx</span>(<span class="exitfail">EXIT_FAILURE</span>, <span class="str">"No count specified"</span>);

  vstr_cntl_conf(s1-&gt;conf, VSTR_CNTL_CONF_SET_FMT_CHAR_ESC, <span class="chr">'$'</span>);
  <span class="if">if</span> (!vstr_sc_fmt_add_vstr(s1-&gt;conf, <span class="str">"{vstr:%p%zu%zu%u}"</span>) ||
      !vstr_fmt_add(s1-&gt;conf, <span class="str">"&lt;words:%p&gt;"</span>, ex_usr_words_cb,
                    VSTR_TYPE_FMT_PTR_VOID, VSTR_TYPE_FMT_END))
    <span class="errno">errno</span> = ENOMEM, <span class="err">err</span>(<span class="exitfail">EXIT_FAILURE</span>, <span class="str">"Custom formatters"</span>);

#<span class="cppif">if</span> EX_WORDS_USE_TST
  {
    struct Words_tst_conv
    {
     <span class="const">const</span> <span class="char">char</span> *i;
     <span class="const">const</span> <span class="char">char</span> *o;
    }
    tsts[] =
      {
       {<span class="str">"0"</span>,   <span class="str">"Zero"</span>},
       {<span class="str">"1"</span>,   <span class="str">"One"</span>},
       {<span class="str">"2"</span>,   <span class="str">"Two"</span>},
       {<span class="str">"3"</span>,   <span class="str">"Three"</span>},
       {<span class="str">"4"</span>,   <span class="str">"Four"</span>},
       {<span class="str">"5"</span>,   <span class="str">"Five"</span>},
       {<span class="str">"6"</span>,   <span class="str">"Six"</span>},
       {<span class="str">"7"</span>,   <span class="str">"Seven"</span>},
       {<span class="str">"8"</span>,   <span class="str">"Eight"</span>},
       {<span class="str">"9"</span>,   <span class="str">"Nine"</span>},
       {<span class="str">"10"</span>,  <span class="str">"Ten"</span>},
       {<span class="str">"11"</span>,  <span class="str">"Eleven"</span>},
       {<span class="str">"12"</span>,  <span class="str">"Twelve"</span>},
       {<span class="str">"13"</span>,  <span class="str">"Thirteen"</span>},
       {<span class="str">"14"</span>,  <span class="str">"Fourteen"</span>},
       {<span class="str">"15"</span>,  <span class="str">"Fifteen"</span>},
       {<span class="str">"16"</span>,  <span class="str">"Sixteen"</span>},
       {<span class="str">"17"</span>,  <span class="str">"Seventeen"</span>},
       {<span class="str">"18"</span>,  <span class="str">"Eighteen"</span>},
       {<span class="str">"19"</span>,  <span class="str">"Nineteen"</span>},
       {<span class="str">"20"</span>,  <span class="str">"Twenty"</span>},
       {<span class="str">"21"</span>,  <span class="str">"Twenty one"</span>},
       {<span class="str">"29"</span>,  <span class="str">"Twenty nine"</span>},
       {<span class="str">"30"</span>,  <span class="str">"Thirty"</span>},
       {<span class="str">"34"</span>,  <span class="str">"Thirty four"</span>},
       {<span class="str">"40"</span>,  <span class="str">"Forty"</span>},
       {<span class="str">"50"</span>,  <span class="str">"Fifty"</span>},
       {<span class="str">"60"</span>,  <span class="str">"Sixty"</span>},
       {<span class="str">"70"</span>,  <span class="str">"Seventy"</span>},
       {<span class="str">"80"</span>,  <span class="str">"Eighty"</span>},
       {<span class="str">"90"</span>,  <span class="str">"Ninety"</span>},
       {<span class="str">"100"</span>, <span class="str">"One hundred"</span>},
       {<span class="str">"190"</span>, <span class="str">"One hundred and ninety"</span>},
       {<span class="str">"200"</span>, <span class="str">"Two hundred"</span>},
       {<span class="str">"1000"</span>, <span class="str">"One thousand"</span>},
       {<span class="str">"2000"</span>, <span class="str">"Two thousand"</span>},
       {<span class="str">"3210"</span>, <span class="str">"Three thousand two hundred and ten"</span>},
                                                                                
       {<span class="str">"9876543210"</span>, <span class="str">"Nine billion eight hundred and seventy six million five hundred and forty three thousand two hundred and ten"</span>},
       {<span class="str">"9876543210"</span> VAL0_9(), <span class="str">"Nine quintillion eight hundred and seventy six quadrillion five hundred and forty three trillion two hundred and ten billion"</span>},
       {<span class="str">"-3210"</span>, <span class="str">"Minus three thousand two hundred and ten"</span>},
      };
    <span class="unsigned">unsigned</span> <span class="int">int</span> alen = sizeof(tsts) / sizeof(tsts[0]);
    struct Words_tst_conv *scan = tsts;
    

    <span class="while">while</span> (alen)
    {
      mpz_init_set_str(bignum, scan-&gt;i, <span class="num0">0</span>);

      vstr_del(s1, 1, s1-&gt;len);
      vstr_add_fmt(s1, s1-&gt;len, <span class="str">"$&lt;words:%p&gt;"</span>, (<span class="void">void</span> *)bignum);
      
      <span class="if">if</span> (!vstr_cmp_cstr_eq(s1, 1, s1-&gt;len, scan-&gt;o))
        <span class="err">errx</span>(<span class="exitfail">EXIT_FAILURE</span>, <span class="str">"Tst failed(%s): %s"</span>,
             scan-&gt;o, vstr_export_cstr_ptr(s1, 1, s1-&gt;len));

      --alen;
      ++scan;
    }
  }
#<span class="cppendif">endif</span>
  
  mpz_init_set_str(bignum, argv[1], <span class="num0">0</span>);

  vstr_del(s1, 1, s1-&gt;len);
  vstr_add_fmt(s1, s1-&gt;len, <span class="str">" Input: %s\n"</span>, argv[1]);
  vstr_add_fmt(s1, s1-&gt;len, <span class="str">" Words: $&lt;words:%p&gt;\n"</span>, (<span class="void">void</span> *)bignum);
  
  <span class="if">if</span> (s1-&gt;conf-&gt;malloc_bad)
    <span class="errno">errno</span> = ENOMEM, <span class="err">err</span>(<span class="exitfail">EXIT_FAILURE</span>, <span class="str">"Add string data"</span>);
  
  io_put_all(s1, <span class="stdout">STDOUT_FILENO</span>);

  <span class="exit">exit</span> (ex_exit(s1, <span class="null">NULL</span>));
}
</pre>
<!-- C to html convertion of ex_gmp_num_words.c -->
<!--   done on Thu May 13 03:35:34 2004 -->
<!--   done by ex_highlight -->

  </body>
</html>
