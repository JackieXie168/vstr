<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <title>c2html for: ex_rot13.c</title>
    <link rel="stylesheet" type="text/css" href="f_c.css">
  </head>
  <body>
     <h1>ex_rot13.c</h1>
<pre class="c2html">
<span class="comment">/* do a rot13 of ASCII text */</span>

#<span class="cppinclude">include</span> <span class="str">"ex_utils.h"</span>

<span class="comment">/* configuration:
   how to do it ... */</span>
#<span class="cppdefine">define</span> EX_ROT13_USE_ITER        1
#<span class="cppdefine">define</span> EX_ROT13_USE_EXPORT_CHR  <span class="num0">0</span>
#<span class="cppdefine">define</span> EX_ROT13_USE_SUB_CHR     <span class="num0">0</span>
#<span class="cppdefine">define</span> EX_ROT13_USE_CSTR_MALLOC <span class="num0">0</span>

#<span class="cppdefine">define</span> ROT13_LETTER(x) ( \
 (((x) &gt;= <span class="chr">'A'</span> &amp;&amp; (x) &lt;= <span class="chr">'M'</span>) || \
  ((x) &gt;= <span class="chr">'a'</span> &amp;&amp; (x) &lt;= <span class="chr">'m'</span>)) ? ((x) + 13) : ((x) - 13) \
 )

#<span class="cppif">if</span> <span class="num0">0</span>
#<span class="cppdefine">define</span> ROT13_MAP(x) ( \
 ((((x) &gt;= <span class="chr">'A'</span>) &amp;&amp; ((x) &lt;= <span class="chr">'Z'</span>)) || \
  (((x) &gt;= <span class="chr">'a'</span>) &amp;&amp; ((x) &lt;= <span class="chr">'z'</span>))) ? ROT13_LETTER(x) : (x) \
 )
#<span class="cppelse">else</span>
<span class="static">static</span> <span class="char">char</span> rot13_map[] = {
 1*   <span class="num0">0</span>,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15,
 1*  16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31,
 1*  32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47,
 1*  48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63,
 1*  64, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 65, 66,
 1*  67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 91, 92, 93, 94, 95,
 1*  96,110,111,112,113,114,115,116,117,118,119,120,121,122, 97, 98,
 1*  99,100,101,102,103,104,105,106,107,108,109,123,124,125,126,127,
 1* 128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,
 1* 144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,
 1* 160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,
 1* 176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,
 1* 192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,
 1* 208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,
 1* 224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,
 1* 240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255};
#<span class="cppdefine">define</span> ROT13_MAP(x) rot13_map[(<span class="unsigned">unsigned</span> <span class="char">char</span>)(x)]
#<span class="cppendif">endif</span>

<span class="static">static</span> <span class="int">int</span> ex_rot13_process(<span class="vstrbase">Vstr_base</span> *s1, <span class="vstrbase">Vstr_base</span> *s2)
{
  <span class="sizet">size_t</span> count = <span class="num0">0</span>;
  <span class="static">static</span> <span class="const">const</span> <span class="char">char</span> chrs[] = (<span class="str">"abcdefghijklmnopqrstuvwxyz"</span>
                              <span class="str">"ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span>);

  <span class="comment">/* we don't want to create more data, if we are over our limit */</span>
  <span class="if">if</span> (s1-&gt;len &gt; EX_MAX_W_DATA_INCORE)
    <span class="return">return</span> (<span class="false">FALSE</span>);

  <span class="if">if</span> (!s2-&gt;len)
    <span class="return">return</span> (<span class="false">FALSE</span>);

  <span class="if">if</span> (EX_ROT13_USE_ITER)
  {
    Vstr_iter iter[1];

    <span class="if">if</span> (!vstr_iter_fwd_beg(s2, 1, s2-&gt;len, iter))
      abort();

    <span class="do">do</span>
    {
      <span class="unsigned">unsigned</span> <span class="int">int</span> scan = <span class="num0">0</span>;
      <span class="while">while</span> (scan &lt; iter-&gt;len)
      {
        <span class="char">char</span> tmp = ROT13_MAP(iter-&gt;ptr[scan]);
        vstr_add_rep_chr(s1, s1-&gt;len, tmp, 1);
        ++scan;
      }
    } <span class="while">while</span> (vstr_iter_fwd_nxt(iter));

    vstr_del(s2, 1, s2-&gt;len);
  }

  <span class="if">if</span> (EX_ROT13_USE_EXPORT_CHR)
  {
    <span class="unsigned">unsigned</span> <span class="int">int</span> scan = <span class="num0">0</span>;
    <span class="while">while</span> (scan++ &lt; s2-&gt;len)
    {
      <span class="char">char</span> tmp = vstr_export_chr(s2, scan);
      tmp = ROT13_MAP(tmp);
      vstr_add_rep_chr(s1, s1-&gt;len, tmp, 1);
    }
    vstr_del(s2, 1, s2-&gt;len);
  }
  
  <span class="if">if</span> (EX_ROT13_USE_SUB_CHR)
  {
    <span class="unsigned">unsigned</span> <span class="int">int</span> scan = <span class="num0">0</span>;

    <span class="while">while</span> (scan++ &lt; s2-&gt;len)
    {
      <span class="char">char</span> tmp = vstr_export_chr(s2, scan);
      tmp = ROT13_MAP(tmp);
      vstr_sub_rep_chr(s2, scan, 1, tmp, 1);
    }
    vstr_add_vstr(s1, s1-&gt;len, s2, 1, s2-&gt;len,
                  VSTR_TYPE_ADD_BUF_REF);
    vstr_del(s2, 1, s2-&gt;len);
  }
  
  <span class="if">if</span> (EX_ROT13_USE_CSTR_MALLOC)
  <span class="while">while</span> (s2-&gt;len)
  {
    <span class="if">if</span> ((count = VSTR_CSPN_CSTR_CHRS_FWD(s2, 1, s2-&gt;len, chrs)))
    {
      vstr_add_vstr(s1, s1-&gt;len, s2, 1, count,
                    VSTR_TYPE_ADD_BUF_REF);
      vstr_del(s2, 1, count);

      <span class="if">if</span> (s1-&gt;len &gt; EX_MAX_W_DATA_INCORE)
        <span class="return">return</span> (<span class="true">TRUE</span>);
    }

    <span class="if">if</span> ((count = VSTR_SPN_CSTR_CHRS_FWD(s2, 1, s2-&gt;len, chrs)))
    {
      <span class="char">char</span> *ptr = vstr_export_cstr_malloc(s2, 1, count);
      Vstr_ref *ref = vstr_ref_make_ptr(ptr, vstr_ref_cb_free_ptr_ref);

      <span class="if">if</span> (!ref || !ref-&gt;ptr)
        <span class="errno">errno</span> = ENOMEM, <span class="err">err</span>(<span class="exitfail">EXIT_FAILURE</span>, <span class="str">"vstr_make_conf"</span>);

      <span class="while">while</span> (*ptr)
      {
        *ptr = ROT13_LETTER(*ptr);
        ++ptr;
      }

      vstr_add_ref(s1, s1-&gt;len, ref, <span class="num0">0</span>, count);
      vstr_del(s2, 1, count);
    }
  }

  <span class="return">return</span> (<span class="true">TRUE</span>);
}


<span class="static">static</span> <span class="void">void</span> ex_rot13_read_fd_write_stdout(<span class="vstrbase">Vstr_base</span> *s1, <span class="vstrbase">Vstr_base</span> *s2, <span class="int">int</span> fd)
{
  <span class="while">while</span> (<span class="true">TRUE</span>)
  {
    <span class="int">int</span> io_w_state = IO_OK;
    <span class="int">int</span> io_r_state = io_get(s2, fd);

    <span class="if">if</span> (io_r_state == IO_EOF)
      <span class="break">break</span>;

    ex_rot13_process(s1, s2);

    io_w_state = io_put(s1, 1);

    io_limit(io_r_state, fd, io_w_state, 1, s1);
  }
}

<span class="static">static</span> <span class="void">void</span> ex_rot13_process_limit(<span class="vstrbase">Vstr_base</span> *s1, <span class="vstrbase">Vstr_base</span> *s2,
                                   <span class="unsigned">unsigned</span> <span class="int">int</span> lim)
{
  <span class="while">while</span> (s2-&gt;len &gt; lim)
  {
    <span class="int">int</span> proc_data = ex_rot13_process(s1, s2);
    <span class="if">if</span> (!proc_data &amp;&amp; (io_put(s1, <span class="stdout">STDOUT_FILENO</span>) == IO_BLOCK))
      io_block(<span class="numm1">-1</span>, <span class="stdout">STDOUT_FILENO</span>);
  }
}


<span class="int">int</span> main(<span class="int">int</span> argc, <span class="char">char</span> *argv[])
{
  <span class="vstrbase">Vstr_base</span> *s1 = <span class="null">NULL</span>;
  <span class="vstrbase">Vstr_base</span> *s2 = ex_init(&amp;s1);
  <span class="int">int</span> count = 1;

  <span class="if">if</span> (count &gt;= argc)  <span class="comment">/* use stdin */</span>
  {
    io_fd_set_o_nonblock(<span class="stdin">STDIN_FILENO</span>);
    ex_rot13_read_fd_write_stdout(s1, s2, <span class="stdin">STDIN_FILENO</span>);
  }

  <span class="comment">/* loop through all arguments, open the file specified
   * and do the read/write loop */</span>
  <span class="while">while</span> (count &lt; argc)
  {
    <span class="unsigned">unsigned</span> <span class="int">int</span> ern = <span class="num0">0</span>;

    <span class="if">if</span> (s2-&gt;len &lt; EX_MAX_R_DATA_INCORE)
      vstr_sc_mmap_file(s2, s2-&gt;len, argv[count], <span class="num0">0</span>, <span class="num0">0</span>, &amp;ern);

    <span class="if">if</span> ((ern == VSTR_TYPE_SC_MMAP_FILE_ERR_FSTAT_ERRNO) ||
        (ern == VSTR_TYPE_SC_MMAP_FILE_ERR_MMAP_ERRNO) ||
        (ern == VSTR_TYPE_SC_MMAP_FILE_ERR_TOO_LARGE))
    {
      <span class="int">int</span> fd = io_open(argv[count]);

      ex_rot13_read_fd_write_stdout(s1, s2, fd);

      <span class="if">if</span> (close(fd) == <span class="numm1">-1</span>)
        <span class="warn">warn</span>(<span class="str">"close(%s)"</span>, argv[count]);
    }
    <span class="else">else</span> <span class="if">if</span> (ern &amp;&amp; (ern != VSTR_TYPE_SC_MMAP_FILE_ERR_CLOSE_ERRNO))
      <span class="err">err</span>(<span class="exitfail">EXIT_FAILURE</span>, <span class="str">"add"</span>);
    <span class="else">else</span>
      ex_rot13_process_limit(s1, s2, EX_MAX_R_DATA_INCORE);

    ++count;
  }

  ex_rot13_process_limit(s1, s2, <span class="num0">0</span>);

  io_put_all(s1, <span class="stdout">STDOUT_FILENO</span>);

  <span class="exit">exit</span> (ex_exit(s1, s2));
}
</pre>
<!-- C to html convertion of ex_rot13.c -->
<!--   done on Fri May 14 06:15:24 2004 -->
<!--   done by ex_highlight -->

  </body>
</html>
