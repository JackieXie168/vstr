<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <title>c2html for: ex_rainbow.c</title>
    <link rel="stylesheet" type="text/css" href="f_c.css">
  </head>
  <body>
     <h1>ex_rainbow.c</h1>
<pre class="c2html">
<span class="comment">/* Prints a rainbow in html span tags, using css...
 *
 * red    (0xF00), orange, yellow (0xFF0),
 * yellow (0xFF0),         green  (0x0F0),
 * green  (0x0F0),         cyan   (0x0FF),
 * cyan   (0x0FF),         blue   (0x00F),
 * blue   (0x00F), indigo, violet (0xF0F)
 *
 * ... repeat.
 */</span>
#<span class="cppinclude">include</span> <span class="str">"ex_utils.h"</span>

#<span class="cppdefine">define</span> EX_RAINBOW_USE_256 <span class="num0">0</span> <span class="comment">/* use a 256 or a 16 step gradient color change */</span>
#<span class="cppdefine">define</span> EX_RAINBOW_USE_PUNCT 1 <span class="comment">/* color punctuation chars */</span>

#<span class="cppdefine">define</span> EX_RAINBOW_PUNCT_CHARS \
    <span class="str">"!\"#$%&amp;'()*+,-./:;&lt;=&gt;?[\\]^_`{|}~"</span>
#<span class="cppdefine">define</span> EX_RAINBOW_ALPHA_CHARS \
    <span class="str">"ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span>                            \
    <span class="str">"abcdefghijklmnopqrstuvwxyz"</span>                            \
    <span class="str">"0123456789"</span>

#<span class="cppif">if</span> EX_RAINBOW_USE_PUNCT
#<span class="cppdefine">define</span> EX_RAINBOW_CHARS EX_RAINBOW_ALPHA_CHARS EX_RAINBOW_PUNCT_CHARS
#<span class="cppelse">else</span>
#<span class="cppdefine">define</span> EX_RAINBOW_CHARS EX_RAINBOW_ALPHA_CHARS
#<span class="cppendif">endif</span>

<span class="comment">/* states */</span>
#<span class="cppdefine">define</span> EX_RAINBOW_ST_R2Y <span class="num0">0</span>
#<span class="cppdefine">define</span> EX_RAINBOW_ST_Y2G 1
#<span class="cppdefine">define</span> EX_RAINBOW_ST_G2C 2
#<span class="cppdefine">define</span> EX_RAINBOW_ST_C2B 3
#<span class="cppdefine">define</span> EX_RAINBOW_ST_B2V 4
#<span class="cppdefine">define</span> EX_RAINBOW_ST_V2R 5

<span class="static">static</span> struct 
{
 <span class="unsigned">unsigned</span> <span class="int">int</span> r;
 <span class="unsigned">unsigned</span> <span class="int">int</span> g;
 <span class="unsigned">unsigned</span> <span class="int">int</span> b;
 <span class="int">int</span> state;
} color = {(EX_RAINBOW_USE_256 ? 0xFF : 0xF), <span class="num0">0</span>, <span class="num0">0</span>, 0};


<span class="static">static</span> <span class="void">void</span> ex_rainbow_process(<span class="vstrbase">Vstr_base</span> *s1, <span class="vstrbase">Vstr_base</span> *s2)
{
  <span class="while">while</span> (s2-&gt;len)
  {
    <span class="sizet">size_t</span> skip = vstr_cspn_cstr_chrs_fwd(s2, 1, s2-&gt;len, EX_RAINBOW_CHARS);
    <span class="int">int</span> hexsz = EX_RAINBOW_USE_256 * 2;
    <span class="unsigned">unsigned</span> <span class="int">int</span> hexmax = (EX_RAINBOW_USE_256 ? 0xFF : 0xF);
    <span class="unsigned">unsigned</span> <span class="int">int</span> hexmin = <span class="num0">0</span>;
    
    vstr_add_vstr(s1, s1-&gt;len, s2, 1, skip, VSTR_TYPE_ADD_DEF);
    vstr_del(s2, 1, skip);
  
    <span class="if">if</span> (!s2-&gt;len)
      <span class="return">return</span>;

    <span class="assert">ASSERT</span>(color.r &lt;= hexmax);
    <span class="assert">ASSERT</span>(color.g &lt;= hexmax);
    <span class="assert">ASSERT</span>(color.b &lt;= hexmax);
  
    vstr_add_fmt(s1, s1-&gt;len,
                 <span class="str">"&lt;span style=\"color: #%0*x%0*x%0*x\"&gt;"</span>
                 <span class="str">"${vstr:%p%zu%zu%u}"</span>
                 <span class="str">"&lt;/span&gt;"</span>,
                 hexsz, color.r, hexsz, color.g, hexsz, color.b,
                 s2, 1, 1, VSTR_TYPE_ADD_DEF);
    
    <span class="if">if</span> (s1-&gt;conf-&gt;malloc_bad)
      <span class="errno">errno</span> = ENOMEM, <span class="err">err</span>(<span class="exitfail">EXIT_FAILURE</span>, <span class="str">"adding data"</span>);
    
    vstr_del(s2, 1, 1);
    
    <span class="switch">switch</span> (color.state)
    {
      <span class="case">case</span> EX_RAINBOW_ST_R2Y:
        <span class="if">if</span> (++color.g == hexmax) color.state = EX_RAINBOW_ST_Y2G; <span class="break">break</span>;
      <span class="case">case</span> EX_RAINBOW_ST_Y2G:
        <span class="if">if</span> (--color.r == hexmin) color.state = EX_RAINBOW_ST_G2C; <span class="break">break</span>;
      <span class="case">case</span> EX_RAINBOW_ST_G2C:
        <span class="if">if</span> (++color.b == hexmax) color.state = EX_RAINBOW_ST_C2B; <span class="break">break</span>;
      <span class="case">case</span> EX_RAINBOW_ST_C2B:
        <span class="if">if</span> (--color.g == hexmin) color.state = EX_RAINBOW_ST_B2V; <span class="break">break</span>;
      <span class="case">case</span> EX_RAINBOW_ST_B2V:
        <span class="if">if</span> (++color.r == hexmax) color.state = EX_RAINBOW_ST_V2R; <span class="break">break</span>;
      <span class="case">case</span> EX_RAINBOW_ST_V2R:
        <span class="if">if</span> (--color.b == hexmin) color.state = EX_RAINBOW_ST_R2Y; <span class="break">break</span>;
        
      <span class="default">default</span>:
        <span class="assert">ASSERT</span>(<span class="false">FALSE</span>);
    }
  }
}

<span class="static">static</span> <span class="void">void</span> ex_rainbow_read_fd_write_stdout(<span class="vstrbase">Vstr_base</span> *s1,
                                            <span class="vstrbase">Vstr_base</span> *s2, <span class="int">int</span> fd)
{
  <span class="while">while</span> (<span class="true">TRUE</span>)
  {
    <span class="int">int</span> io_w_state = IO_OK;
    <span class="int">int</span> io_r_state = io_get(s2, fd);

    <span class="if">if</span> (io_r_state == IO_EOF)
      <span class="break">break</span>;
    
    ex_rainbow_process(s1, s2);

    io_w_state = io_put(s1, 1);
    
    io_limit(io_r_state, fd, io_w_state, 1, s1);    
  }
  
  ex_rainbow_process(s1, s2);
}

<span class="int">int</span> main(<span class="int">int</span> argc, <span class="char">char</span> *argv[])
{
  <span class="vstrbase">Vstr_base</span> *s2 = <span class="null">NULL</span>;
  <span class="vstrbase">Vstr_base</span> *s1 = ex_init(&amp;s2);
  <span class="int">int</span> count = 1;

  vstr_cntl_conf(<span class="null">NULL</span>, VSTR_CNTL_CONF_SET_FMT_CHAR_ESC, <span class="chr">'$'</span>);
  vstr_sc_fmt_add_all(<span class="null">NULL</span>);

  <span class="if">if</span> (!s1-&gt;conf)
    <span class="errno">errno</span> = ENOMEM, <span class="err">err</span>(<span class="exitfail">EXIT_FAILURE</span>, <span class="str">"custom formatters"</span>);

  <span class="if">if</span> (count &gt;= argc)
  {
    io_fd_set_o_nonblock(<span class="stdin">STDIN_FILENO</span>);
    ex_rainbow_read_fd_write_stdout(s1, s2, <span class="stdin">STDIN_FILENO</span>);
  }  

  <span class="while">while</span> (count &lt; argc)
  {
    <span class="int">int</span> fd = io_open(argv[count]);

    ex_rainbow_read_fd_write_stdout(s1, s2, fd);

    <span class="if">if</span> (close(fd) == <span class="numm1">-1</span>)
      <span class="warn">warn</span>(<span class="str">"close(%s)"</span>, argv[count]);

    ++count;
  }

  io_put_all(s1, <span class="stdout">STDOUT_FILENO</span>);

  <span class="exit">exit</span> (ex_exit(s1, s2));
}
</pre>
<!-- C to html convertion of ex_rainbow.c -->
<!--   done on Sun May  9 02:29:54 2004
 -->
<!--   done by ex_highlight -->

  </body>
</html>