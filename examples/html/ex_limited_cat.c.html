<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <title>c2html for: ex_limited_cat.c</title>
    <link rel="stylesheet" type="text/css" href="f_c.css">
  </head>
  <body>
     <h1>ex_limited_cat.c</h1>
<pre class="c2html">
<span class="comment">/* This is a limited cat program.
 * Reads from stdin if no args are given.
 */</span>
#<span class="cppdefine">define</span> EX_UTILS_NO_USE_BLOCK 1
#<span class="cppdefine">define</span> EX_UTILS_NO_USE_LIMIT 1
#<span class="cppinclude">include</span> <span class="str">"ex_utils.h"</span>

#<span class="cppinclude">include</span> &lt;sys/time.h&gt;
#<span class="cppinclude">include</span> &lt;time.h&gt;

struct Ex_limcat_stats
{
 <span class="unsigned">unsigned</span> <span class="int">int</span>  total;
 <span class="unsigned">unsigned</span> <span class="int">int</span> *data;
 time_t       *stmp;
 <span class="sizet">size_t</span>        sz;
 <span class="sizet">size_t</span>        pos;
};

typedef struct Ex_limcat_opts
{
  <span class="unsigned">unsigned</span> <span class="int">int</span> ilimit;
  <span class="unsigned">unsigned</span> <span class="int">int</span> olimit;
  <span class="unsigned">unsigned</span> <span class="int">int</span> period;

 <span class="comment">/* stats */</span>
 struct Ex_limcat_stats stat_i;
 struct Ex_limcat_stats stat_o;
} Ex_limcat_opts;

#<span class="cppdefine">define</span> EX_LIM_SECS(x, y) (difftime(x, y))

<span class="static">static</span> <span class="void">void</span> lim_clear(struct Ex_limcat_stats *stats)
{
  time_t now = time(<span class="null">NULL</span>);
  
  stats-&gt;total = <span class="num0">0</span>;
  stats-&gt;pos   = <span class="num0">0</span>;

  <span class="while">while</span> (stats-&gt;pos &lt; stats-&gt;sz)
  {
    stats-&gt;data[stats-&gt;pos] = <span class="num0">0</span>;
    stats-&gt;stmp[stats-&gt;pos] = now;
    ++stats-&gt;pos;
  }

  stats-&gt;pos   = <span class="num0">0</span>;
}

<span class="static">static</span> <span class="void">void</span> lim_init(struct Ex_limcat_stats *stats, <span class="unsigned">unsigned</span> <span class="int">int</span> sz)
{
  <span class="if">if</span> (!(stats-&gt;data = malloc(sizeof(<span class="unsigned">unsigned</span> <span class="int">int</span>) * sz)))
    <span class="err">err</span>(<span class="exitfail">EXIT_FAILURE</span>, <span class="str">"init"</span>);

  <span class="if">if</span> (!(stats-&gt;stmp = malloc(sizeof(time_t) * sz)))
    <span class="err">err</span>(<span class="exitfail">EXIT_FAILURE</span>, <span class="str">"init"</span>);

  stats-&gt;sz    = sz;
  lim_clear(stats);
}

<span class="static">static</span> <span class="void">void</span> lim_add(struct Ex_limcat_stats *stats, time_t now, <span class="unsigned">unsigned</span> <span class="int">int</span> val)
{
  <span class="unsigned">unsigned</span> <span class="int">int</span> secs = EX_LIM_SECS(now, stats-&gt;stmp[stats-&gt;pos]);
  
  <span class="if">if</span> (secs &gt;= stats-&gt;sz)
    secs = stats-&gt;sz;
  
  <span class="do">do</span>
  {
    stats-&gt;pos = (stats-&gt;pos + 1) % stats-&gt;sz;

    <span class="assert">ASSERT</span>(stats-&gt;total &gt;= stats-&gt;data[stats-&gt;pos]);
    
    stats-&gt;total            -= stats-&gt;data[stats-&gt;pos];
    stats-&gt;data[stats-&gt;pos]  = <span class="num0">0</span>;
    stats-&gt;stmp[stats-&gt;pos]  = now;
  } <span class="while">while</span> (--secs);

  stats-&gt;data[stats-&gt;pos] += val;
  stats-&gt;total            += val;
}

<span class="static">static</span> <span class="int">int</span> lim_calc_ok(struct Ex_limcat_stats *stats, <span class="unsigned">unsigned</span> <span class="int">int</span> limit)
{
  <span class="if">if</span> (stats-&gt;total &lt; limit)
    <span class="return">return</span> (<span class="true">TRUE</span>);

  <span class="return">return</span> (<span class="false">FALSE</span>);
}

<span class="comment">/* block waiting for IO read, write or both... */</span>
<span class="static">static</span> <span class="void">void</span> io_block(<span class="int">int</span> io_r_fd, <span class="int">int</span> io_w_fd, <span class="int">int</span> wait_secs)
{
  <span class="pollfd">struct pollfd</span> ios_beg[2];
  <span class="pollfd">struct pollfd</span> *ios = ios_beg;
  <span class="unsigned">unsigned</span> <span class="int">int</span> num = <span class="num0">0</span>;
  
  ios[0].revents = ios[1].revents = <span class="num0">0</span>;
  
  <span class="if">if</span> (io_r_fd == io_w_fd)
  { <span class="comment">/* block on both read and write, same fds */</span>
    num = 1;
    ios[0].events = POLLIN | POLLOUT;
    ios[0].fd     = io_w_fd;
  }
  <span class="else">else</span>
  { <span class="comment">/* block on read or write or both */</span>
    <span class="if">if</span> (io_r_fd != <span class="numm1">-1</span>)
    {
      ios-&gt;events = POLLIN;
      ios-&gt;fd     = io_r_fd;
      ++num; ++ios;
    }
    <span class="if">if</span> (io_w_fd != <span class="numm1">-1</span>)
    {
      ios-&gt;events = POLLOUT;
      ios-&gt;fd     = io_w_fd;
      ++num; ++ios;
    }
  }

  <span class="if">if</span> (poll(ios_beg, num, wait_secs) == <span class="numm1">-1</span>)
  {
    <span class="if">if</span> (<span class="errno">errno</span> != EINTR)
      <span class="err">err</span>(<span class="exitfail">EXIT_FAILURE</span>, <span class="str">"poll"</span>);
  }
}

  <span class="comment">/* block read or writting, depending on limits */</span>
<span class="static">static</span> <span class="void">void</span> io_limit(<span class="int">int</span> io_r_state, <span class="int">int</span> io_r_fd,
                     <span class="int">int</span> io_w_state, <span class="int">int</span> io_w_fd, <span class="vstrbase">Vstr_base</span> *s_w)
{
  <span class="if">if</span> (io_w_state == IO_BLOCK) <span class="comment">/* allow 16k to build up */</span>
  {
    <span class="if">if</span> (io_r_state == IO_BLOCK) <span class="comment">/* block to either get or put some data */</span>
      io_block(io_r_fd, io_w_fd, <span class="numm1">-1</span>);
    <span class="else">else</span> <span class="if">if</span> (s_w-&gt;len &gt; EX_MAX_W_DATA_INCORE)
      io_block(<span class="numm1">-1</span>, io_w_fd, <span class="numm1">-1</span>); <span class="comment">/* block to put more data */</span>
  }
  <span class="else">else</span> <span class="if">if</span> ((io_w_state == IO_NONE) &amp;&amp; (io_r_state == IO_BLOCK))
    io_block(io_r_fd, <span class="numm1">-1</span>, <span class="numm1">-1</span>); <span class="comment">/* block to get more data */</span>
}


<span class="static">static</span> <span class="void">void</span> ex_limcat_read_fd_write_stdout(Ex_limcat_opts *opts,
                                           <span class="vstrbase">Vstr_base</span> *s1, <span class="int">int</span> fd)
{
  <span class="while">while</span> (<span class="true">TRUE</span>)
  {
    <span class="int">int</span> io_w_state = IO_OK;
    <span class="int">int</span> io_r_state = io_get(s1, fd);

    <span class="if">if</span> (io_r_state == IO_EOF)
      <span class="break">break</span>;
    
    io_w_state = io_put(s1, 1);

    io_limit(io_r_state, fd, io_w_state, 1, s1);    
  }
}

<span class="static">static</span> <span class="void">void</span> ex_limcat_write_stdout(Ex_limcat_opts *opts, <span class="vstrbase">Vstr_base</span> *s1)
{
  <span class="int">int</span> state = IO_NONE;

  <span class="while">while</span> ((state = io_put(s1, <span class="stdout">STDOUT_FILENO</span>)) != IO_NONE)
  {
    <span class="if">if</span> (state == IO_BLOCK)
      io_block(<span class="numm1">-1</span>, <span class="stdout">STDOUT_FILENO</span>, <span class="numm1">-1</span>);
  }
}

<span class="static">static</span> <span class="unsigned">unsigned</span> <span class="int">int</span> arg_lim(<span class="int">int</span> *count, <span class="int">int</span> argc, <span class="char">char</span> *argv[])
{
  <span class="char">char</span> *end = <span class="null">NULL</span>;
  <span class="unsigned">unsigned</span> <span class="int">int</span> ret = <span class="num0">0</span>;
  
  <span class="if">if</span> (++*count == argc)
    <span class="err">errx</span>(<span class="exitfail">EXIT_FAILURE</span>, <span class="str">"No argument for limit."</span>);

  ret = strtoul(argv[*count], &amp;end, 10);

  <span class="if">if</span> (!end[0] || !end[1])
    <span class="switch">switch</span> (*end)
    {
      <span class="case">case</span> 0:   <span class="return">return</span> (ret);
      <span class="case">case</span> <span class="chr">'b'</span>: <span class="return">return</span> (ret);
      <span class="case">case</span> <span class="chr">'k'</span>: <span class="return">return</span> (ret * 1024);
      <span class="case">case</span> <span class="chr">'m'</span>: <span class="return">return</span> (ret * 1024 * 1024);
      <span class="case">case</span> <span class="chr">'g'</span>: <span class="return">return</span> (ret * 1024 * 1024 * 1024);
      <span class="default">default</span>:
        <span class="break">break</span>;
    }

  <span class="err">errx</span>(<span class="exitfail">EXIT_FAILURE</span>, <span class="str">"Bad format for limit."</span>);
}

<span class="static">static</span> <span class="unsigned">unsigned</span> <span class="int">int</span> arg_period(<span class="int">int</span> *count, <span class="int">int</span> argc, <span class="char">char</span> *argv[])
{
  <span class="char">char</span> *end = <span class="null">NULL</span>;
  <span class="unsigned">unsigned</span> <span class="int">int</span> ret = <span class="num0">0</span>;
  
  <span class="if">if</span> (++*count == argc)
    <span class="err">errx</span>(<span class="exitfail">EXIT_FAILURE</span>, <span class="str">"No argument for period."</span>);

  ret = strtoul(argv[*count], &amp;end, 10);

  <span class="if">if</span> (!end[0] || !end[1])
    <span class="switch">switch</span> (*end)
    {
      <span class="case">case</span> 0:   <span class="return">return</span> (ret);
      <span class="case">case</span> <span class="chr">'s'</span>: <span class="return">return</span> (ret);
      <span class="case">case</span> <span class="chr">'m'</span>: <span class="return">return</span> (ret * 60);
      <span class="case">case</span> <span class="chr">'h'</span>: <span class="return">return</span> (ret * 60 * 60);
      <span class="case">case</span> <span class="chr">'d'</span>: <span class="return">return</span> (ret * 60 * 60 * 24);
      <span class="default">default</span>:
        <span class="break">break</span>;
    }

  <span class="err">errx</span>(<span class="exitfail">EXIT_FAILURE</span>, <span class="str">"Bad format for period."</span>);
}

<span class="int">int</span> main(<span class="int">int</span> argc, <span class="char">char</span> *argv[])
{ 
  <span class="vstrbase">Vstr_base</span> *s1 = ex_init(<span class="null">NULL</span>); <span class="comment">/* init the library etc. */</span>
  <span class="int">int</span> count = 1; <span class="comment">/* skip the program name */</span>
  <span class="unsigned">unsigned</span> <span class="int">int</span> use_mmap = <span class="false">FALSE</span>;
  <span class="static">static</span> Ex_limcat_opts opts[1] = {{2 * 1024, 2 * 1024, 15}};

  <span class="while">while</span> (count &lt; argc)
  {
    <span class="if">if</span> (!strcmp(<span class="str">"--"</span>, argv[count]))
    {
      ++count;
      <span class="break">break</span>;
    }
    
    <span class="else">else</span> <span class="if">if</span> (!strcmp(<span class="str">"--mmap"</span>, argv[count]))
      use_mmap = !use_mmap;
    
    <span class="else">else</span> <span class="if">if</span> (!strcmp(<span class="str">"--ilimit"</span>, argv[count]))
      opts-&gt;ilimit = arg_lim(&amp;count, argc, argv);
    <span class="else">else</span> <span class="if">if</span> (!strcmp(<span class="str">"--olimit"</span>, argv[count]))
      opts-&gt;olimit = arg_lim(&amp;count, argc, argv);
    <span class="else">else</span> <span class="if">if</span> (!strcmp(<span class="str">"--iolimit"</span>, argv[count]))
      opts-&gt;ilimit = opts-&gt;olimit = arg_lim(&amp;count, argc, argv);
    
    <span class="else">else</span> <span class="if">if</span> (!strcmp(<span class="str">"--period"</span>, argv[count]))
      opts-&gt;period = arg_period(&amp;count, argc, argv);
    
    <span class="else">else</span> <span class="if">if</span> (!strcmp(<span class="str">"--version"</span>, argv[count]))
    { <span class="comment">/* print version and exit */</span>
      vstr_add_fmt(s1, <span class="num0">0</span>, <span class="str">"%s"</span>, <span class="str">"\
jlimcat 1.0.0\n\
Written by James Antill\n\
\n\
Uses Vstr string library.\n\
"</span>);
      <span class="goto">goto</span> out;
    }
    <span class="else">else</span> <span class="if">if</span> (!strcmp(<span class="str">"--help"</span>, argv[count]))
    { <span class="comment">/* print version and exit */</span>
      vstr_add_fmt(s1, <span class="num0">0</span>, <span class="str">"%s"</span>, <span class="str">"\
Usage: jlimcat [FILENAME]...\n\
   or: jlimcat OPTION\n\
Output filenames.\n\
\n\
      --help     Display this help and exit\n\
      --version  Output version information and exit\n\
      --ilimit   Limit of input per second (default 2k).\n\
      --olimit   Limit of output per second (default 2k).\n\
      --iolimit  Limit of input and output per second (default 2k).\n\
      --period   Period of time given as a buffer (default 15s).\n\
      --mmap     Toggle use of mmap() to load input files.\n\
      --         Treat rest of cmd line as input filenames\n\
\n\
Report bugs to James Antill &lt;james@and.org&gt;.\n\
"</span>);
      <span class="goto">goto</span> out;
    }
    <span class="else">else</span>
      <span class="break">break</span>;
    ++count;
  }

  <span class="comment">/* if no arguments are given just do stdin to stdout */</span>
  <span class="if">if</span> (count &gt;= argc)
  {
    io_fd_set_o_nonblock(<span class="stdin">STDIN_FILENO</span>);
    ex_limcat_read_fd_write_stdout(opts, s1, <span class="stdin">STDIN_FILENO</span>);
  }
  
  <span class="comment">/* loop through all arguments, open the file specified
   * and do the read/write loop */</span>
  <span class="while">while</span> (count &lt; argc)
  {
    <span class="unsigned">unsigned</span> <span class="int">int</span> ern = <span class="num0">0</span>;
    
    <span class="comment">/* try to mmap the file */</span>
    <span class="if">if</span> (use_mmap)
      vstr_sc_mmap_file(s1, s1-&gt;len, argv[count], <span class="num0">0</span>, <span class="num0">0</span>, &amp;ern);
 
    <span class="if">if</span> (!use_mmap ||
        (ern == VSTR_TYPE_SC_MMAP_FILE_ERR_FSTAT_ERRNO) ||
        (ern == VSTR_TYPE_SC_MMAP_FILE_ERR_MMAP_ERRNO) ||
        (ern == VSTR_TYPE_SC_MMAP_FILE_ERR_TOO_LARGE))
    { <span class="comment">/* if mmap didn't work ... do a read/alter/write loop */</span>
      <span class="int">int</span> fd = io_open(argv[count]);

      ex_limcat_read_fd_write_stdout(opts, s1, fd);

      <span class="if">if</span> (close(fd) == <span class="numm1">-1</span>)
        <span class="warn">warn</span>(<span class="str">"close(%s)"</span>, argv[count]);
    }
    <span class="else">else</span> <span class="if">if</span> (ern &amp;&amp; (ern != VSTR_TYPE_SC_MMAP_FILE_ERR_CLOSE_ERRNO))
      <span class="err">err</span>(<span class="exitfail">EXIT_FAILURE</span>, <span class="str">"mmap"</span>);
    <span class="else">else</span> <span class="if">if</span> (s1-&gt;len &gt; EX_MAX_R_DATA_INCORE)
      ex_limcat_write_stdout(opts, s1);

    ++count;
  }

  <span class="comment">/* output all remaining data */</span>
  ex_limcat_write_stdout(opts, s1);

  <span class="exit">exit</span> (ex_exit(s1, <span class="null">NULL</span>));
}
</pre>
<!-- C to html convertion of ex_limited_cat.c -->
<!--   done on Sun May  9 02:29:53 2004
 -->
<!--   done by ex_highlight -->

  </body>
</html>