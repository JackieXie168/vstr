<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <title>c2html for: ex_perf_sgopenssl.c</title>
    <link rel="stylesheet" type="text/css" href="f_c.css">
  </head>
  <body>
     <h1>ex_perf_sgopenssl.c</h1>
<pre class="c2html">
<span class="comment">/* This file tests how efficient it is to hand off data in chunks as against as
 * one big pile
 * -- vstr is kind of built on the idea that this isn't a problem for
 *    reasonable sizes */</span>

#<span class="cppdefine">define</span> VSTR_COMPILE_INCLUDE 1

#<span class="cppinclude">include</span> &lt;vstr.h&gt;

#<span class="cppifndef">ifndef</span> TSTSG_USE_MD5
# <span class="cppdefine">define</span> TSTSG_USE_MD5 <span class="num0">0</span>
#<span class="cppendif">endif</span>

#<span class="cppifndef">ifndef</span> TST_SZ <span class="comment">/* chunk size for custom Vstr */</span>
# <span class="cppdefine">define</span> TST_SZ ((1024 * 4) - (sizeof(Vstr_node) + 16)) <span class="comment">/* one page each */</span>
#<span class="cppendif">endif</span>

#<span class="cppifndef">ifndef</span> TST_NUM <span class="comment">/* number of times to perform each test */</span>
# <span class="cppdefine">define</span> TST_NUM (256)
#<span class="cppendif">endif</span>

#<span class="cppif">if</span> TSTSG_USE_MD5
<span class="comment">/* do md5 test ... */</span>
#<span class="cppinclude">include</span> &lt;openssl/md5.h&gt;

# <span class="cppdefine">define</span> TSTSG_CTX     MD5_CTX
# <span class="cppdefine">define</span> TSTSG_INIT    MD5_Init
# <span class="cppdefine">define</span> TSTSG_UPDATE  MD5_Update
# <span class="cppdefine">define</span> TSTSG_FINI    MD5_Final
# <span class="cppdefine">define</span> TSTSG_OUT_LEN MD5_DIGEST_LENGTH
# <span class="cppdefine">define</span> TSTSG_NAME    <span class="str">"MD5"</span>
#<span class="cppelse">else</span>
<span class="comment">/* do sha1 test .. */</span>
#<span class="cppinclude">include</span> &lt;openssl/sha.h&gt;

# <span class="cppdefine">define</span> TSTSG_CTX     SHA_CTX
# <span class="cppdefine">define</span> TSTSG_INIT    SHA_Init
# <span class="cppdefine">define</span> TSTSG_UPDATE  SHA_Update
# <span class="cppdefine">define</span> TSTSG_FINI    SHA_Final
# <span class="cppdefine">define</span> TSTSG_OUT_LEN SHA_DIGEST_LENGTH
# <span class="cppdefine">define</span> TSTSG_NAME    <span class="str">"SHA"</span>
#<span class="cppendif">endif</span>

#<span class="cppinclude">include</span> <span class="str">"ex_perf.h"</span>

#<span class="cppdefine">define</span> TST_SSL_BEG() TST_BEG(TSTSG_OUT_LEN, TST_NUM); \
                      TSTSG_CTX ctx

#<span class="cppdefine">define</span> TST_SSL_INIT() TSTSG_INIT(&amp;ctx)

#<span class="cppdefine">define</span> TST_SSL_END(name) \
        		TSTSG_FINI(buf_out, &amp;ctx); \
                        TST_END(name)

#<span class="cppinclude">include</span> &lt;assert.h&gt;

<span class="int">int</span> main(<span class="int">int</span> argc, <span class="char">char</span> *argv[])
{
  Vstr_conf *conf = <span class="null">NULL</span>;
  <span class="vstrbase">Vstr_base</span> *out = <span class="null">NULL</span>;
  <span class="vstrbase">Vstr_base</span> *s1 = <span class="null">NULL</span>;
  <span class="vstrbase">Vstr_base</span> *s2 = <span class="null">NULL</span>;
  <span class="vstrbase">Vstr_base</span> *s3 = <span class="null">NULL</span>;
  <span class="unsigned">unsigned</span> <span class="int">int</span> err = <span class="num0">0</span>;

  <span class="if">if</span> (!vstr_init())
    exit(<span class="exitfail">EXIT_FAILURE</span>);

  conf = vstr_make_conf();
  <span class="if">if</span> (!conf)
    exit(<span class="exitfail">EXIT_FAILURE</span>);

  <span class="comment">/* have a custom config. for output and s1 ... */</span>
  vstr_cntl_conf(conf, VSTR_CNTL_CONF_SET_NUM_BUF_SZ, TST_SZ);

  vstr_cntl_conf(conf, VSTR_CNTL_CONF_SET_LOC_CSTR_THOU_SEP, <span class="str">"_"</span>);
  vstr_cntl_conf(conf, VSTR_CNTL_CONF_SET_LOC_CSTR_THOU_GRP, <span class="str">"\3"</span>);

  vstr_cntl_conf(conf, VSTR_CNTL_CONF_SET_FMT_CHAR_ESC, <span class="chr">'$'</span>);
  vstr_sc_fmt_add_all(conf);


  out = vstr_make_base(conf); <span class="comment">/* used as stdio/stdout */</span>

  s1 = vstr_make_base(conf); <span class="comment">/* configured size */</span>
  s2 = vstr_make_base(<span class="null">NULL</span>); <span class="comment">/* mmap */</span>
  s3 = vstr_make_base(<span class="null">NULL</span>); <span class="comment">/* default size */</span>
  vstr_free_conf(conf);
  <span class="if">if</span> (!out || !s1 || !s2 || !s3)
    exit(<span class="exitfail">EXIT_FAILURE</span>);

  <span class="if">if</span> (argc != 2)
  {
    vstr_add_fmt(out, out-&gt;len,
                 <span class="str">" Format: %s &lt;filename&gt;\n"</span>, argv[0]);
    <span class="goto">goto</span> failed;
  }

  vstr_sc_mmap_file(s2, s2-&gt;len, argv[1], <span class="num0">0</span>, <span class="num0">0</span>, &amp;err);
  <span class="if">if</span> (err)
    <span class="exit">exit</span> (<span class="exitfail">EXIT_FAILURE</span>);

  vstr_add_vstr(s3, s1-&gt;len, s2, 1, s2-&gt;len, VSTR_TYPE_ADD_ALL_BUF);
  vstr_add_vstr(s1, s1-&gt;len, s2, 1, s2-&gt;len, VSTR_TYPE_ADD_ALL_BUF);

  <span class="if">if</span> (conf-&gt;malloc_bad)
    <span class="exit">exit</span> (<span class="exitfail">EXIT_FAILURE</span>);

  <span class="comment">/* with I/O the iovec would be valid */</span>
  vstr_export_iovec_ptr_all(s1, <span class="null">NULL</span>, <span class="null">NULL</span>);
  vstr_export_iovec_ptr_all(s3, <span class="null">NULL</span>, <span class="null">NULL</span>);

  <span class="comment">/* print table to say what config we are using ... */</span>
  vstr_add_fmt(out, out-&gt;len,
               <span class="str">"+${rep_chr:%c%zu}"</span>
               <span class="str">"+${rep_chr:%c%zu}"</span>
               <span class="str">"+${rep_chr:%c%zu}"</span>
               <span class="str">"+${rep_chr:%c%zu}+\n"</span>,
               <span class="chr">'='</span>, 17, <span class="chr">'='</span>, 18, <span class="chr">'='</span>, 18, <span class="chr">'='</span>, 18);
  vstr_add_fmt(out, out-&gt;len, <span class="str">"|%16s | %16s | %16s | %16s |\n"</span>,
               <span class="str">"name"</span>, <span class="str">"len"</span>, <span class="str">"chunks"</span>, <span class="str">"chunk size"</span>);

  vstr_add_fmt(out, out-&gt;len,
               <span class="str">"+${rep_chr:%c%zu}"</span>
               <span class="str">"+${rep_chr:%c%zu}"</span>
               <span class="str">"+${rep_chr:%c%zu}"</span>
               <span class="str">"+${rep_chr:%c%zu}+\n"</span>,
               <span class="chr">'-'</span>, 17, <span class="chr">'-'</span>, 18, <span class="chr">'-'</span>, 18, <span class="chr">'-'</span>, 18);
  {
    <span class="unsigned">unsigned</span> <span class="int">int</span> sz = <span class="num0">0</span>;

    vstr_cntl_conf(s1-&gt;conf, VSTR_CNTL_CONF_GET_NUM_BUF_SZ, &amp;sz);
    vstr_add_fmt(out, out-&gt;len,
                 <span class="str">"|%16s | $16{BKMG.u:%u} | %'16zu | $16{BKMG.u:%u} |\n"</span>,
                 <span class="str">"s1:  conf iovs"</span>, (<span class="unsigned">unsigned</span> <span class="int">int</span>)s1-&gt;conf-&gt;buf_sz, s1-&gt;num, sz);

    vstr_add_fmt(out, out-&gt;len,
                 <span class="str">"|%16s | $16{BKMG.u:%u} | %'16zu | %16s |\n"</span>,
                 <span class="str">"s2:       mmap"</span>, (<span class="unsigned">unsigned</span> <span class="int">int</span>)s2-&gt;len, s2-&gt;num, <span class="str">"N/A"</span>);

    vstr_cntl_conf(s3-&gt;conf, VSTR_CNTL_CONF_GET_NUM_BUF_SZ, &amp;sz);
    vstr_add_fmt(out, out-&gt;len,
                 <span class="str">"|%16s | $16{BKMG.u:%u} | %'16zu | $16{BKMG.u:%u} |\n"</span>,
                 <span class="str">"s3:   def iovs"</span>, (<span class="unsigned">unsigned</span> <span class="int">int</span>)s3-&gt;conf-&gt;buf_sz, s3-&gt;num, sz);
  }
  vstr_add_fmt(out, out-&gt;len,
               <span class="str">"+${rep_chr:%c%zu}"</span>
               <span class="str">"+${rep_chr:%c%zu}"</span>
               <span class="str">"+${rep_chr:%c%zu}"</span>
               <span class="str">"+${rep_chr:%c%zu}+\n"</span>,
               <span class="chr">'-'</span>, 17, <span class="chr">'-'</span>, 18, <span class="chr">'-'</span>, 18, <span class="chr">'-'</span>, 18);
  vstr_add_fmt(out, out-&gt;len, <span class="str">" Doing tests %'u times with %s:\n"</span>,
               (<span class="unsigned">unsigned</span> <span class="int">int</span>)TST_NUM, TSTSG_NAME);

  <span class="while">while</span> (out-&gt;len &amp;&amp; !err)
    vstr_sc_write_fd(out, 1, out-&gt;len, 1 <span class="comment">/* stdout */</span>, &amp;err);

  TST_HDR_BEG();

  TST_SSL_BEG();
  struct iovec *iovs = <span class="null">NULL</span>;
  <span class="unsigned">unsigned</span> <span class="int">int</span> count = <span class="num0">0</span>;
  <span class="unsigned">unsigned</span> <span class="int">int</span> num = <span class="num0">0</span>;
  <span class="sizet">size_t</span> len = <span class="num0">0</span>;

  TST_SSL_INIT();

  len = vstr_export_iovec_ptr_all(s1, &amp;iovs, &amp;num);

  <span class="while">while</span> (count &lt; num)
  {
    TSTSG_UPDATE(&amp;ctx, iovs[count].iov_base, iovs[count].iov_len);
    ++count;
  }
  TST_SSL_END(<span class="str">"s1:  conf iovs"</span>);

  TST_SSL_BEG();
  Vstr_ref *ref = <span class="null">NULL</span>;
  <span class="sizet">size_t</span> off = <span class="num0">0</span>;

  TST_SSL_INIT();

  ref = vstr_export_ref(s2, 1, s2-&gt;len, &amp;off);
  <span class="assert">assert</span>(off == <span class="num0">0</span>);

  TSTSG_UPDATE(&amp;ctx, ref-&gt;ptr, s1-&gt;len);

  vstr_ref_del(ref);
  TST_SSL_END(<span class="str">"s2:       mmap"</span>);

  vstr_export_iovec_ptr_all(s3, <span class="null">NULL</span>, <span class="null">NULL</span>);
  TST_SSL_BEG();
  struct iovec *iovs = <span class="null">NULL</span>;
  <span class="unsigned">unsigned</span> <span class="int">int</span> count = <span class="num0">0</span>;
  <span class="unsigned">unsigned</span> <span class="int">int</span> num = <span class="num0">0</span>;
  <span class="sizet">size_t</span> len = <span class="num0">0</span>;

  TST_SSL_INIT();
  len = vstr_export_iovec_ptr_all(s3, &amp;iovs, &amp;num);

  <span class="while">while</span> (count &lt; num)
  {
    TSTSG_UPDATE(&amp;ctx, iovs[count].iov_base, iovs[count].iov_len);
    ++count;
  }
  TST_SSL_END(<span class="str">"s3:   def iovs"</span>);

  TST_HDR_END();

  <span class="if">if</span> (s1-&gt;conf-&gt;malloc_bad || s2-&gt;conf-&gt;malloc_bad || s3-&gt;conf-&gt;malloc_bad)
    <span class="goto">goto</span> failed;

  <span class="while">while</span> (out-&gt;len &amp;&amp; !err)
    vstr_sc_write_fd(out, 1, out-&gt;len, 1 <span class="comment">/* stdout */</span>, &amp;err);

  vstr_free_base(out);
  vstr_free_base(s1);
  vstr_free_base(s2);
  vstr_free_base(s3);

  vstr_exit();

  <span class="exit">exit</span> (<span class="exitsucs">EXIT_SUCCESS</span>);

 failed:
  <span class="while">while</span> (out-&gt;len &amp;&amp; !err)
    vstr_sc_write_fd(out, 1, out-&gt;len, 2 <span class="comment">/* stderr */</span>, &amp;err);

  vstr_free_base(out);
  vstr_free_base(s1);
  vstr_free_base(s2);
  vstr_free_base(s3);

  vstr_exit();

  <span class="exit">exit</span> (<span class="exitfail">EXIT_FAILURE</span>);
}
</pre>
<!-- C to html convertion of ex_perf_sgopenssl.c -->
<!--   done on Mon Jan 26 05:27:54 2004
 -->
<!--   done by ex_highlight -->

  </body>
</html>