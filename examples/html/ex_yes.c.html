<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <title>c2html for: ex_yes.c</title>
    <link rel="stylesheet" type="text/css" href="f_c.css">
  </head>
  <body>
     <h1>ex_yes.c</h1>
<pre class="c2html">
<span class="comment">/* Unix "yes" command */</span>

#<span class="cppdefine">define</span> EX_UTILS_NO_USE_INPUT 1

#<span class="cppinclude">include</span> <span class="str">"ex_utils.h"</span>

#<span class="cppinclude">include</span> &lt;limits.h&gt;

#<span class="cppdefine">define</span> OUT_DEF_NUM 2 <span class="comment">/* how many lines to add at once, by default */</span>

#<span class="cppdefine">define</span> OUT_LIM_DEF_NUM <span class="num0">0</span> <span class="comment">/* how many lines to do in total, by default */</span>

#<span class="cppdefine">define</span> OUT_PTR 1 <span class="comment">/* copy ptr's to data */</span>
#<span class="cppdefine">define</span> OUT_BUF 2 <span class="comment">/* copy data to */</span>
#<span class="cppdefine">define</span> OUT_REF 3 <span class="comment">/* copy data once, to coalese */</span>

#<span class="cppdefine">define</span> MAX_W_DATA_INCORE (1024 * 128)

<span class="static">static</span> <span class="unsigned">unsigned</span> <span class="int">int</span> sz = MAX_W_DATA_INCORE;

<span class="int">int</span> main(<span class="int">int</span> argc, <span class="char">char</span> *argv[])
{ <span class="comment">/* This is "yes", without any command line options */</span>
  <span class="vstrbase">Vstr_base</span> *cmd_line = <span class="null">NULL</span>;
  <span class="vstrbase">Vstr_base</span> *s1 = ex_init(&amp;cmd_line);
  <span class="int">int</span> count = 1; <span class="comment">/* skip program name */</span>
  <span class="unsigned">unsigned</span> <span class="int">int</span> out_type = OUT_PTR;
  <span class="unsigned">unsigned</span> <span class="int">int</span> out_num = OUT_DEF_NUM;
  <span class="unsigned">unsigned</span> <span class="int">int</span> lim_num = OUT_LIM_DEF_NUM;
  <span class="const">const</span> <span class="char">char</span> *out_filename = <span class="null">NULL</span>;
  <span class="int">int</span> out_fd = <span class="numm1">-1</span>;

  <span class="while">while</span> (count &lt; argc)
  { <span class="comment">/* quick hack getopt_long */</span>
    <span class="if">if</span> (!strcmp(<span class="str">"--"</span>, argv[count]))
    {
      ++count;
      <span class="break">break</span>;
    }
    <span class="else">else</span> <span class="if">if</span> (!strcmp(<span class="str">"--ptr"</span>, argv[count]))
      out_type = OUT_PTR;
    <span class="else">else</span> <span class="if">if</span> (!strcmp(<span class="str">"--buf"</span>, argv[count]))
      out_type = OUT_BUF;
    <span class="else">else</span> <span class="if">if</span> (!strcmp(<span class="str">"--ref"</span>, argv[count]))
      out_type = OUT_REF;
    EX_UTILS_GETOPT_NUM(<span class="str">"sz"</span>,    sz);
    EX_UTILS_GETOPT_NUM(<span class="str">"num"</span>,   out_num);
    EX_UTILS_GETOPT_NUM(<span class="str">"limit"</span>, lim_num);
    EX_UTILS_GETOPT_NUM(<span class="str">"lim"</span>,   lim_num);
    EX_UTILS_GETOPT_CSTR(<span class="str">"file"</span>,  out_filename);
    <span class="else">else</span> <span class="if">if</span> (!strcmp(<span class="str">"--version"</span>, argv[count]))
    {
      vstr_add_fmt(s1, <span class="num0">0</span>, <span class="str">"%s"</span>, <span class="str">"\
yes 1.0.0\n\
Written by James Antill\n\
\n\
Uses Vstr string library.\n\
"</span>);
      <span class="goto">goto</span> out;
    }
    <span class="else">else</span> <span class="if">if</span> (!strcmp(<span class="str">"--help"</span>, argv[count]))
    {
      vstr_add_fmt(s1, <span class="num0">0</span>, <span class="str">"%s"</span>, <span class="str">"\
Usage: yes [STRING]...\n\
   or: yes OPTION\n\
Repeatedly output a line with all specified STRING(s), or `y'.\n\
\n\
      --help     display this help and exit\n\
      --version  output version information and exit\n\
      --ptr      output using pointers to data\n\
      --buf      output using copies of data\n\
      --ref      output using single copy of data, with references\n\
      --num      number of times to add the line, between output calls\n\
      --sz       output maximum size, lower bound\n\
      --         Use rest of cmd line input regardless of if it's an option\n\
\n\
Report bugs to James Antill &lt;james@and.org&gt;.\n\
"</span>);
      <span class="goto">goto</span> out;
    }
    <span class="else">else</span>
      <span class="break">break</span>;
    ++count;
  }

  <span class="if">if</span> (count &gt;= argc)
    VSTR_ADD_CSTR_PTR(cmd_line, cmd_line-&gt;len, <span class="str">"y"</span>);

  {
    <span class="int">int</span> added = <span class="false">FALSE</span>;

    <span class="while">while</span> (count &lt; argc)
    {
      <span class="if">if</span> (added) <span class="comment">/* already done one argument */</span>
        VSTR_ADD_CSTR_PTR(cmd_line, cmd_line-&gt;len, <span class="str">" "</span>);
      VSTR_ADD_CSTR_PTR(cmd_line, cmd_line-&gt;len, argv[count]);

      ++count;
      added = <span class="true">TRUE</span>;
    }
  }

  VSTR_ADD_CSTR_PTR(cmd_line, cmd_line-&gt;len, <span class="str">"\n"</span>);

  <span class="if">if</span> (<span class="num0">0</span>)
  { <span class="assert">ASSERT</span>(<span class="false">FALSE</span>); }
  <span class="else">else</span> <span class="if">if</span> (out_type == OUT_PTR)
  { <span class="comment">/* do nothing */</span> }
  <span class="else">else</span> <span class="if">if</span> (out_type == OUT_BUF)
  {
    <span class="sizet">size_t</span> len = cmd_line-&gt;len;
    vstr_add_vstr(cmd_line, len, cmd_line, 1, len, VSTR_TYPE_ADD_ALL_BUF);
    vstr_del(cmd_line, 1, len);
  }
  <span class="else">else</span> <span class="if">if</span> (out_type == OUT_REF)
  {
    <span class="sizet">size_t</span> len = cmd_line-&gt;len;
    vstr_add_vstr(cmd_line, len, cmd_line, 1, len, VSTR_TYPE_ADD_ALL_REF);
    vstr_del(cmd_line, 1, len);
  }
  <span class="else">else</span>
    <span class="err">errx</span>(<span class="exitsucs">EXIT_SUCCESS</span>, <span class="str">"INTERNAL ERROR ... bad out_type"</span>);

  <span class="if">if</span> (cmd_line-&gt;conf-&gt;malloc_bad)
    <span class="errno">errno</span> = ENOMEM, <span class="err">err</span>(<span class="exitsucs">EXIT_SUCCESS</span>, <span class="str">"Creating output string: %m\n"</span>);

  <span class="if">if</span> (!out_num)
    ++out_num;

  <span class="if">if</span> (!out_filename)
    out_fd = 1;
  <span class="else">else</span>
    out_fd = io_open(out_filename);

  <span class="comment">/* BEG: main loop */</span>

  <span class="do">do</span>
  {
    count = out_num;

    <span class="while">while</span> ((s1-&gt;len &lt; sz) &amp;&amp; (--count &gt;= <span class="num0">0</span>))
      vstr_add_vstr(s1, s1-&gt;len, cmd_line, 1, cmd_line-&gt;len, VSTR_TYPE_ADD_DEF);

    <span class="if">if</span> ((io_put(s1, out_fd) == IO_BLOCK) &amp;&amp; (s1-&gt;len &gt;= sz))
      io_block(<span class="numm1">-1</span>, out_fd);
    
    <span class="comment">/* 0 == infinity */</span>
    if    (lim_num == 1) <span class="break">break</span>;
    if    (lim_num &gt;  1) --lim_num;
  } <span class="while">while</span> (<span class="true">TRUE</span>);

 out:
  io_put_all(s1, out_fd);

  <span class="exit">exit</span> (ex_exit(s1, cmd_line));
}
</pre>
<!-- C to html convertion of ex_yes.c -->
<!--   done on Fri May 14 06:15:25 2004 -->
<!--   done by ex_highlight -->

  </body>
</html>
