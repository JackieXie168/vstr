<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <title>c2html for: ex_lookup_ip.c</title>
    <link rel="stylesheet" type="text/css" href="f_c.css">
  </head>
  <body>
     <h1>ex_lookup_ip.c</h1>
<pre class="c2html">
<span class="comment">/* This is a _simple_ program to lookup a hostname via. gethostbyname().
 *
 * This shows how easy it is to use custom format specifiers, to make your code
 * easier to write and maintain.
 *
 * This file is more commented than normal code, so as to make it easy to follow
 * while knowning almost nothing about Vstr or Linux IO programming.
 */</span>
#<span class="cppdefine">define</span> EX_UTILS_NO_USE_INPUT 1
#<span class="cppdefine">define</span> EX_UTILS_NO_USE_OPEN 1

#<span class="cppinclude">include</span> <span class="str">"ex_utils.h"</span>

#<span class="cppinclude">include</span> &lt;sys/socket.h&gt;
#<span class="cppinclude">include</span> &lt;netdb.h&gt;


<span class="int">int</span> main(<span class="int">int</span> argc, <span class="char">char</span> *argv[])
{
  <span class="vstrbase">Vstr_base</span> *s1 = ex_init(<span class="null">NULL</span>); <span class="comment">/* init the library, and create a string */</span>
  struct hostent *hp = <span class="null">NULL</span>; <span class="comment">/* data from the resolver library */</span>

  <span class="comment">/* setup the pre-written custom format specifier for IPv4 addresses,
   */</span>
  vstr_cntl_conf(s1-&gt;conf, VSTR_CNTL_CONF_SET_FMT_CHAR_ESC, <span class="chr">'$'</span>);
  vstr_sc_fmt_add_ipv4_ptr(s1-&gt;conf, <span class="str">"{IPv4:%p}"</span>);


  <span class="if">if</span> (argc != 2) <span class="comment">/* if a hostname isn't given output an message to stderr */</span>
  {
    <span class="sizet">size_t</span> pos = <span class="num0">0</span>;
    <span class="sizet">size_t</span> len = <span class="num0">0</span>;

    <span class="comment">/* add another format specifier for printing Vstr strings */</span>
    vstr_sc_fmt_add_vstr(s1-&gt;conf, <span class="str">"{Vstr:%p%zu%zu%u}"</span>);

    <span class="comment">/* find the program name ...
     * putting it at the begining of the Vstr string */</span>
    vstr_add_cstr_ptr(s1, <span class="num0">0</span>, argc ? argv[0] : <span class="str">"lookup_ip"</span>);
    vstr_sc_basename(s1, 1, s1-&gt;len, &amp;pos, &amp;len);

    <span class="comment">/* add a format line to the Vstr string, including the program name
     * which is at the begining of this Vstr string itself */</span>
    len = vstr_add_fmt(s1, s1-&gt;len, <span class="str">" %s ${Vstr:%p%zu%zu%u} %s\n"</span>,
                       <span class="str">"Format:"</span>,
                       s1, pos, len, <span class="num0">0</span>,
                       <span class="str">"&lt;hostname&gt;"</span>);

    vstr_del(s1, 1, s1-&gt;len - len); <span class="comment">/* delete the original program name */</span>

    io_put_all(s1, <span class="stderr">STDERR_FILENO</span>);

    <span class="exit">exit</span> (<span class="exitfail">EXIT_FAILURE</span>);
  }


  <span class="comment">/* call libc to lookup the hostname */</span>
  hp = gethostbyname(argv[1]);


  <span class="comment">/* just print the relevant data.... Note that nothing complicated needs to
   * be done to print the IPv4 address, the custom formatter takes care of
   * it */</span>
  <span class="if">if</span> (!hp)
    vstr_add_fmt(s1, <span class="num0">0</span>, <span class="str">" Error retrieving hostname '%s': %s.\n"</span>,
                 argv[1], hstrerror(h_errno));
  <span class="else">else</span> <span class="if">if</span> (hp-&gt;h_addrtype == AF_INET)
    vstr_add_fmt(s1, <span class="num0">0</span>, <span class="str">" The hostname '%s' has an "</span>
                 <span class="str">"IPv4 address of \"${IPv4:%p}\".\n"</span>, hp-&gt;h_name,
                 hp-&gt;h_addr_list[0]);
  <span class="else">else</span>
    vstr_add_fmt(s1, <span class="num0">0</span>, <span class="str">" The hostname '%s' has an address type that "</span>
                 <span class="str">"isn't an IPv4 address.\n"</span>,
                 hp-&gt;h_name);


  <span class="comment">/* Cleanup... */</span>
  io_put_all(s1, <span class="stdout">STDOUT_FILENO</span>);

  <span class="exit">exit</span> (ex_exit(s1, <span class="null">NULL</span>));
}
</pre>
<!-- C to html convertion of ex_lookup_ip.c -->
<!--   done on Mon Jan 26 05:27:54 2004
 -->
<!--   done by ex_highlight -->

  </body>
</html>